<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0b0f19">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="EdgeScore">
<link rel="manifest" href="/manifest.json">
<link rel="icon" type="image/svg+xml" href="/icons/icon-192.svg">
<link rel="apple-touch-icon" href="/icons/icon-192.svg">
<title>JA EdgeScore</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0b0f19;
  --surface:#141a2e;
  --surface-border:rgba(255,255,255,0.04);
  --elevated:#1a2138;
  --text:#e8eaed;
  --text-dim:#8b92a5;
  --text-muted:#545b6e;
  --accent:#3b82f6;
  --accent-soft:rgba(59,130,246,0.12);
  --amber:#f59e0b;
  --amber-soft:rgba(245,158,11,0.12);
  --success:#22c55e;
  --danger:#ef4444;
  --nba:#ea580c;--nfl:#3b82f6;--soccer:#22c55e;--nhl:#06b6d4;--mlb:#ef4444;--ncaab:#a855f7;
  --home:#3b82f6;--away:#ef4444;--draw:#a855f7;
  --over:#22c55e;--under:#f59e0b;--yes:#22c55e;--no:#ef4444;
  --score-green:#22c55e;--score-lime:#84cc16;--score-amber:#f59e0b;--score-red:#ef4444;
  --radius:12px;--radius-sm:8px;--radius-xs:6px;
  --header-h:56px;
  --shadow-card:0 1px 3px rgba(0,0,0,0.3),0 4px 12px rgba(0,0,0,0.2);
  --shadow-card-hover:0 4px 16px rgba(0,0,0,0.4),0 8px 24px rgba(0,0,0,0.25);
  --shadow-expanded:0 4px 24px rgba(59,130,246,0.15),0 12px 32px rgba(0,0,0,0.3);
}
html{font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);font-size:13px;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
body{min-height:100vh;overflow-x:hidden}

::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:10px}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.18)}

/* ===== HEADER ===== */
.header{position:sticky;top:0;z-index:100;height:var(--header-h);background:rgba(11,15,25,0.85);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border-bottom:1px solid rgba(255,255,255,0.06);display:flex;align-items:center;padding:0 24px}
.header-inner{display:flex;align-items:center;gap:16px;width:100%;max-width:1400px;margin:0 auto}
.logo{display:flex;align-items:center;gap:10px;flex-shrink:0}
.logo h1{font-size:17px;font-weight:800;letter-spacing:-0.5px;color:var(--text);white-space:nowrap}

/* Sport chips */
.sport-chips{display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none;flex:1;min-width:0;justify-content:center}
.sport-chips::-webkit-scrollbar{display:none}
.chip{padding:6px 14px;font-size:12px;font-weight:600;border:1px solid rgba(255,255,255,0.08);border-radius:20px;background:rgba(255,255,255,0.04);color:var(--text-dim);cursor:pointer;transition:all 0.2s;font-family:inherit;white-space:nowrap;letter-spacing:0.1px;backdrop-filter:blur(8px)}
.chip:hover{background:rgba(255,255,255,0.08);color:var(--text);border-color:rgba(255,255,255,0.15)}
.chip.active{background:#fff;color:#0b0f19;border-color:#fff;font-weight:700}

/* Header right */
.header-right{display:flex;align-items:center;gap:10px;flex-shrink:0}
.analyst-link{text-decoration:none;display:inline-flex;align-items:center;gap:5px;padding:6px 14px;font-size:12px;font-weight:600;border:1px solid rgba(255,255,255,0.08);border-radius:20px;background:rgba(255,255,255,0.04);color:var(--text-dim);transition:all 0.2s;font-family:inherit}
.analyst-link:hover{background:rgba(255,255,255,0.08);color:var(--text)}
.date-input{padding:6px 10px;font-size:12px;border:1px solid rgba(255,255,255,0.1);border-radius:20px;background:rgba(255,255,255,0.06);color:var(--text);font-family:inherit;cursor:pointer;width:130px;transition:all 0.2s}
.date-input::-webkit-calendar-picker-indicator{filter:invert(1);opacity:0.5}
.date-input:hover{background:rgba(255,255,255,0.1);border-color:rgba(255,255,255,0.2)}
.health{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text-dim);padding:5px 12px;border-radius:20px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06)}
.health-dot{width:6px;height:6px;border-radius:50%;background:var(--success);box-shadow:0 0 8px rgba(34,197,94,0.6);flex-shrink:0}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.health-dot{animation:pulse 2.5s ease-in-out infinite}

/* ===== LAYOUT ===== */
.container{max-width:1400px;margin:0 auto;padding:0 24px 60px}

/* ===== HERO STATS ===== */
.hero-stats{position:relative;display:flex;align-items:center;justify-content:center;gap:0;padding:20px 28px;margin:20px 0;background:var(--surface);border-radius:var(--radius);overflow:hidden}
.hero-stats::before{content:'';position:absolute;inset:-1px;border-radius:var(--radius);padding:1px;background:linear-gradient(135deg,var(--accent),#8b5cf6,var(--amber));-webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}
.stat-item{display:flex;flex-direction:column;align-items:center;gap:2px;padding:8px 32px;position:relative}
.stat-item:not(:last-child)::after{content:'';position:absolute;right:0;top:15%;height:70%;width:1px;background:rgba(255,255,255,0.06)}
.stat-item .stat-val{font-size:28px;font-weight:800;letter-spacing:-0.5px;color:var(--text);font-variant-numeric:tabular-nums;line-height:1.2}
.stat-item .stat-label{font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;font-weight:600}
@keyframes count-flash{0%{transform:scale(1.1)}100%{transform:scale(1)}}
.stat-item.updated .stat-val{animation:count-flash 0.3s ease-out}

/* ===== TOP PICKS CAROUSEL ===== */
.carousel-section{margin-bottom:28px}
.carousel-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.carousel-header h2{font-size:15px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:10px}
.carousel-header .badge-count{font-size:11px;color:var(--amber);background:var(--amber-soft);padding:3px 10px;border-radius:20px;font-weight:600;font-variant-numeric:tabular-nums}
.carousel-nav{display:flex;gap:6px}
.carousel-btn{width:32px;height:32px;border-radius:50%;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.04);color:var(--text-dim);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;font-size:14px}
.carousel-btn:hover{background:rgba(255,255,255,0.1);color:var(--text);border-color:rgba(255,255,255,0.2)}
.carousel-track{display:flex;gap:14px;overflow-x:auto;scroll-snap-type:x mandatory;scrollbar-width:none;-ms-overflow-style:none;padding:4px 0 8px}
.carousel-track::-webkit-scrollbar{display:none}

/* Top pick cards */
.top-card{flex:0 0 270px;scroll-snap-align:start;background:var(--surface);border:1px solid var(--surface-border);border-radius:var(--radius);padding:18px;position:relative;overflow:hidden;cursor:pointer;transition:all 0.25s}
.top-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-card-hover);border-color:rgba(255,255,255,0.08)}
.top-card.expanded{border-color:var(--accent);box-shadow:var(--shadow-expanded);transform:none}
.top-card-head{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.top-card .score-ring{width:48px;height:48px;font-size:17px}
.top-card-info{flex:1;min-width:0}
.top-card-match{font-size:14px;font-weight:700;letter-spacing:-0.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.top-card-match .vs{color:var(--text-muted);font-weight:400;font-size:11px;margin:0 4px}
.top-card-meta{display:flex;align-items:center;gap:6px;margin-top:4px;flex-wrap:wrap}
.top-card-rank{position:absolute;top:12px;right:14px;font-size:32px;font-weight:900;color:rgba(255,255,255,0.03);line-height:1;letter-spacing:-1px}
.top-card-pills{display:flex;gap:6px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
.ev-badge{font-size:11px;font-weight:700;color:var(--success);background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);padding:3px 8px;border-radius:var(--radius-xs);font-variant-numeric:tabular-nums}
.top-card-analysis{font-size:11px;line-height:1.6;color:var(--text-dim);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.top-card.expanded .top-card-analysis{-webkit-line-clamp:unset;display:block}
.top-card-detail{max-height:0;overflow:hidden;transition:max-height 0.3s cubic-bezier(0.4,0,0.2,1)}
.top-card.expanded .top-card-detail{max-height:500px}
.top-card-sources{padding-top:10px;border-top:1px solid rgba(255,255,255,0.06);margin-top:10px;display:flex;flex-wrap:wrap;gap:4px}

/* ===== SCORE RING (conic gradient) ===== */
.score-ring{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:800;letter-spacing:-0.5px;font-variant-numeric:tabular-nums;flex-shrink:0;position:relative}
.score-ring-bg{position:absolute;inset:0;border-radius:50%;border:3px solid rgba(255,255,255,0.06)}
.score-ring-fill{position:absolute;inset:0;border-radius:50%;-webkit-mask:radial-gradient(farthest-side,transparent calc(100% - 3px),#fff calc(100% - 3px))}
.score-ring-val{position:relative;z-index:1}

/* ===== TABS ===== */
.tabs-container{margin-top:4px}
.tabs-header{display:flex;gap:0;border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:20px;position:relative}
.tab-btn{padding:12px 24px;font-size:13px;font-weight:600;color:var(--text-muted);cursor:pointer;border:none;background:none;font-family:inherit;position:relative;transition:color 0.2s}
.tab-btn:hover{color:var(--text-dim)}
.tab-btn.active{color:var(--text)}
.tab-btn.active::after{content:'';position:absolute;bottom:-1px;left:0;right:0;height:2px;background:var(--accent);border-radius:2px 2px 0 0}
.tab-panel{display:none}
.tab-panel.active{display:block}

/* ===== CONFIDENCE FILTERS ===== */
.conf-filters{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap}
.conf-chip{padding:6px 14px;font-size:11px;font-weight:600;border:1px solid rgba(255,255,255,0.08);border-radius:20px;background:rgba(255,255,255,0.04);color:var(--text-dim);cursor:pointer;transition:all 0.2s;font-family:inherit}
.conf-chip:hover{border-color:var(--accent);color:var(--accent)}
.conf-chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}

/* ===== DATE DIVIDER ===== */
.date-divider{font-size:11px;color:var(--text-muted);padding:16px 0 8px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;display:flex;align-items:center;gap:10px}
.date-divider::after{content:'';flex:1;height:1px;background:rgba(255,255,255,0.06)}
.date-divider .pick-count{font-size:10px;font-weight:600;color:var(--accent);background:var(--accent-soft);padding:2px 8px;border-radius:20px}

/* ===== PICK CARDS ===== */
.picks-list{display:grid;gap:10px;padding-bottom:20px}
.pick-card{background:var(--surface);border:1px solid var(--surface-border);border-radius:var(--radius);overflow:hidden;position:relative;cursor:pointer;transition:all 0.25s;box-shadow:var(--shadow-card)}
.pick-card:hover{box-shadow:var(--shadow-card-hover);transform:translateY(-2px)}
.pick-card.expanded{border-color:rgba(59,130,246,0.3);box-shadow:var(--shadow-expanded);transform:none}
.pick-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px}
.pick-card[data-sport="nba"]::before{background:var(--nba)}
.pick-card[data-sport="nfl"]::before{background:var(--nfl)}
.pick-card[data-sport="soccer"]::before,.pick-card[data-sport="football"]::before{background:var(--soccer)}
.pick-card[data-sport="nhl"]::before{background:var(--nhl)}
.pick-card[data-sport="mlb"]::before{background:var(--mlb)}
.pick-card[data-sport="ncaab"]::before{background:var(--ncaab)}

.pick-header{display:flex;align-items:center;gap:12px;padding:16px 18px 16px 22px}
.pick-info{flex:1;min-width:0}
.pick-teams{font-size:15px;font-weight:700;letter-spacing:-0.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.pick-teams .vs{color:var(--text-muted);font-weight:400;font-size:12px;margin:0 5px}
.pick-meta{display:flex;align-items:center;gap:8px;margin-top:4px;font-size:11px;color:var(--text-muted)}
.sport-badge{font-size:9px;font-weight:700;padding:3px 8px;border-radius:var(--radius-xs);text-transform:uppercase;letter-spacing:0.5px}
.pick-right{display:flex;flex-direction:column;align-items:flex-end;gap:5px;flex-shrink:0}
.rec-pill{font-size:10px;font-weight:700;padding:5px 12px;border-radius:20px;text-transform:uppercase;letter-spacing:0.3px;white-space:nowrap;border:1px solid}
.rec-pill.side-home{background:rgba(59,130,246,0.1);color:var(--home);border-color:rgba(59,130,246,0.25)}
.rec-pill.side-away{background:rgba(239,68,68,0.1);color:var(--away);border-color:rgba(239,68,68,0.25)}
.rec-pill.side-draw{background:rgba(168,85,247,0.1);color:var(--draw);border-color:rgba(168,85,247,0.25)}
.rec-pill.side-over{background:rgba(34,197,94,0.1);color:var(--over);border-color:rgba(34,197,94,0.25)}
.rec-pill.side-under{background:rgba(245,158,11,0.1);color:var(--under);border-color:rgba(245,158,11,0.25)}
.pick-odds{font-size:11px;color:var(--text-dim);font-weight:600;font-variant-numeric:tabular-nums}

/* Pick analysis */
.pick-analysis{padding:0 18px 14px 22px;font-size:12px;line-height:1.65;color:var(--text-dim);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.pick-card.expanded .pick-analysis{-webkit-line-clamp:unset;display:block}

/* Score breakdown bars */
.score-breakdown-bars{padding:0 18px 14px 22px;display:none}
.pick-card.expanded .score-breakdown-bars{display:block}
.breakdown-row{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.breakdown-label{font-size:10px;font-weight:600;color:var(--text-muted);width:72px;flex-shrink:0;text-transform:uppercase;letter-spacing:0.3px}
.breakdown-bar-track{flex:1;height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;max-width:200px}
.breakdown-bar-fill{height:100%;border-radius:3px;transition:width 0.5s ease}
.breakdown-score{font-size:10px;color:var(--text-dim);font-weight:600;font-variant-numeric:tabular-nums;width:40px;text-align:right}

/* Score breakdown inline (compact for collapsed) */
.score-breakdown{display:flex;align-items:center;gap:8px;padding:0 18px 14px 22px;flex-wrap:wrap}
.pick-card.expanded .score-breakdown{display:none}
.score-dot{display:flex;align-items:center;gap:3px;font-size:10px;color:var(--text-muted);font-weight:500;position:relative}
.score-dot .dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.score-dot .tooltip{display:none;position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:var(--elevated);color:var(--text);font-size:10px;font-weight:500;padding:4px 8px;border-radius:4px;white-space:nowrap;pointer-events:none;z-index:10;border:1px solid rgba(255,255,255,0.1)}
.score-dot .tooltip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:4px solid transparent;border-top-color:var(--elevated)}
.score-dot:hover .tooltip{display:block}

/* Pick expanded sources */
.pick-detail{max-height:0;overflow:hidden;transition:max-height 0.35s cubic-bezier(0.4,0,0.2,1)}
.pick-card.expanded .pick-detail{max-height:1000px}
.pick-sources-table{width:100%;border-collapse:collapse;font-size:11px}
.pick-sources-table th{text-align:left;padding:10px 14px 10px 22px;font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;font-weight:700;border-top:1px solid rgba(255,255,255,0.06);background:var(--elevated)}
.pick-sources-table td{padding:10px 14px 10px 22px;border-top:1px solid rgba(255,255,255,0.04);color:var(--text-dim)}
.pick-sources-table .src-name{font-weight:600;color:var(--text)}

/* Source chips */
.source-chips{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px}
.source-chip{font-size:9px;color:var(--text-muted);background:var(--elevated);padding:2px 7px;border-radius:4px;font-weight:500}

/* Side pills */
.side-pill{display:inline-flex;font-size:10px;font-weight:700;padding:3px 8px;border-radius:var(--radius-xs);text-transform:uppercase;letter-spacing:0.3px}
.side-home{background:rgba(59,130,246,0.1);color:var(--home)}
.side-away{background:rgba(239,68,68,0.1);color:var(--away)}
.side-draw{background:rgba(168,85,247,0.1);color:var(--draw)}
.side-over{background:rgba(34,197,94,0.1);color:var(--over)}
.side-under{background:rgba(245,158,11,0.1);color:var(--under)}
.side-yes{background:rgba(34,197,94,0.1);color:var(--yes)}
.side-no{background:rgba(239,68,68,0.1);color:var(--no)}
.conf-pill{display:inline-flex;font-size:10px;font-weight:600;padding:3px 8px;border-radius:var(--radius-xs)}
.conf-best_bet{background:var(--amber-soft);color:var(--amber)}
.conf-high{background:rgba(34,197,94,0.1);color:var(--success)}
.conf-medium{background:rgba(59,130,246,0.1);color:var(--accent)}
.conf-low{background:rgba(255,255,255,0.04);color:var(--text-muted)}

/* ===== VALUE BET CARDS ===== */
.value-cards{display:grid;gap:10px;padding-bottom:20px}
.value-card{background:var(--surface);border:1px solid var(--surface-border);border-radius:var(--radius);padding:18px 20px;cursor:pointer;transition:all 0.25s}
.value-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-card-hover);border-color:rgba(34,197,94,0.15)}
.value-card-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.value-card-match{font-size:14px;font-weight:700;letter-spacing:-0.2px}
.value-card-match .vs{color:var(--text-muted);font-weight:400;font-size:11px;margin:0 4px}
.value-card-ev{font-size:18px;font-weight:800;color:var(--success);font-variant-numeric:tabular-nums}
.value-card-pills{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.value-metrics{display:flex;gap:16px;margin-bottom:12px}
.value-metric{display:flex;flex-direction:column;gap:2px}
.value-metric-label{font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;font-weight:600}
.value-metric-val{font-size:15px;font-weight:700;font-variant-numeric:tabular-nums;color:var(--text)}
.value-card-analysis{font-size:11px;line-height:1.6;color:var(--text-dim);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.value-card.expanded .value-card-analysis{-webkit-line-clamp:unset;display:block}
.value-card-odds{font-size:12px;color:var(--text-dim);font-weight:600;margin-top:8px;font-variant-numeric:tabular-nums}

/* ===== OVER/UNDER CARDS ===== */
.ou-card{background:var(--surface);border:1px solid var(--surface-border);border-radius:var(--radius);padding:14px 18px;cursor:pointer;transition:all 0.25s}
.ou-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-card-hover);border-color:rgba(59,130,246,0.15)}
.ou-card.expanded{border-color:rgba(59,130,246,0.3)}
.ou-card-head{display:flex;align-items:center;gap:12px}
.ou-card-match{flex:1;min-width:0}
.ou-card-match-name{font-size:14px;font-weight:700;letter-spacing:-0.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ou-card-match-name .vs{color:var(--text-muted);font-weight:400;font-size:11px;margin:0 4px}
.ou-card-meta{display:flex;align-items:center;gap:8px;margin-top:3px;font-size:11px;color:var(--text-muted)}
.ou-consensus{display:flex;flex-direction:column;align-items:center;gap:2px;flex-shrink:0}
.ou-consensus-side{font-size:13px;font-weight:800;text-transform:uppercase;letter-spacing:0.5px}
.ou-consensus-side.over{color:#22c55e}
.ou-consensus-side.under{color:#3b82f6}
.ou-consensus-side.split{color:var(--text-muted)}
.ou-consensus-count{font-size:10px;color:var(--text-dim);font-weight:600}
.ou-line{font-size:20px;font-weight:800;color:var(--amber);flex-shrink:0;min-width:48px;text-align:center;font-variant-numeric:tabular-nums}
.ou-bar-wrap{margin-top:10px;display:flex;align-items:center;gap:8px}
.ou-bar-label{font-size:10px;font-weight:700;width:44px;text-align:center;flex-shrink:0}
.ou-bar-label.over{color:#22c55e}
.ou-bar-label.under{color:#3b82f6}
.ou-bar-track{flex:1;height:8px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;display:flex}
.ou-bar-fill-over{height:100%;background:#22c55e;border-radius:4px 0 0 4px;transition:width 0.4s ease}
.ou-bar-fill-under{height:100%;background:#3b82f6;border-radius:0 4px 4px 0;transition:width 0.4s ease}
.ou-sources{margin-top:10px;display:none;flex-wrap:wrap;gap:4px}
.ou-card.expanded .ou-sources{display:flex}
.ou-source-chip{font-size:10px;padding:3px 8px;border-radius:6px;font-weight:600;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.03)}
.ou-source-chip.over{color:#22c55e;border-color:rgba(34,197,94,0.2)}
.ou-source-chip.under{color:#3b82f6;border-color:rgba(59,130,246,0.2)}

/* ===== BEST OVER/UNDER ROW ===== */
.ou-best-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:8px}
.ou-best-col{min-width:0}
.ou-best-header{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:0.6px;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.ou-best-header.over{color:#22c55e}
.ou-best-header.under{color:#3b82f6}
.ou-best-list{display:grid;gap:8px}
.ou-best-card{background:var(--surface);border:1px solid var(--surface-border);border-radius:var(--radius-sm);padding:12px 14px;transition:all 0.2s;cursor:default}
.ou-best-card.over{border-left:3px solid #22c55e}
.ou-best-card.under{border-left:3px solid #3b82f6}
.ou-best-card:hover{border-color:rgba(255,255,255,0.1);box-shadow:var(--shadow-card)}
.ou-best-rank{font-size:10px;font-weight:800;color:var(--text-muted);margin-bottom:4px}
.ou-best-match{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:-0.2px}
.ou-best-meta{display:flex;align-items:center;gap:6px;margin-top:4px;flex-wrap:wrap}
.ou-best-line{font-size:15px;font-weight:800;font-variant-numeric:tabular-nums}
.ou-best-line.over{color:#22c55e}
.ou-best-line.under{color:#3b82f6}
.ou-best-consensus{font-size:10px;color:var(--text-dim);font-weight:600}
.ou-best-sources{display:flex;gap:3px;margin-top:6px;flex-wrap:wrap}
.ou-best-src{font-size:9px;padding:2px 6px;border-radius:4px;background:rgba(255,255,255,0.04);color:var(--text-dim);font-weight:600}
@media(max-width:600px){
  .ou-best-row{grid-template-columns:1fr}
}

/* ===== MATCH CARDS ===== */
.matches-list{display:grid;gap:6px;padding-bottom:20px}
.match-card{display:flex;flex-direction:column;background:var(--surface);border:1px solid var(--surface-border);border-radius:var(--radius-sm);cursor:pointer;transition:all 0.2s;overflow:hidden}
.match-card:hover{box-shadow:var(--shadow-card);border-color:rgba(255,255,255,0.08);transform:translateY(-1px)}
.match-card.expanded{border-color:rgba(59,130,246,0.3);background:rgba(59,130,246,0.03);box-shadow:var(--shadow-expanded);transform:none}
.match-card-header{display:flex;align-items:center;gap:10px;padding:12px 14px}
.sport-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.match-time-col{font-size:11px;color:var(--text-muted);width:52px;flex-shrink:0;font-variant-numeric:tabular-nums;font-weight:600}
.match-teams-col{flex:1;min-width:0;font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:-0.1px}
.match-teams-col .vs{color:var(--text-muted);font-weight:400;font-size:11px;margin:0 3px}
.match-picks-count{font-size:10px;color:var(--accent);background:var(--accent-soft);padding:3px 9px;border-radius:20px;white-space:nowrap;font-variant-numeric:tabular-nums;font-weight:600}
.match-chevron{color:var(--text-muted);font-size:10px;transition:transform 0.2s;flex-shrink:0}
.match-card.expanded .match-chevron{transform:rotate(90deg);color:var(--accent)}
.match-tips{display:flex;gap:5px;padding:0 14px 10px 84px;flex-wrap:wrap}
.match-tip{display:inline-flex;align-items:center;font-size:10px;font-weight:700;padding:3px 8px;border-radius:var(--radius-xs);text-transform:uppercase;letter-spacing:0.3px;white-space:nowrap}

/* Match expanded detail */
.match-detail-wrap{overflow:hidden}
.match-detail{max-height:0;overflow:hidden;transition:max-height 0.35s cubic-bezier(0.4,0,0.2,1)}
.match-card.expanded + .match-detail-wrap .match-detail{max-height:2000px}
.predictions-table{width:100%;border-collapse:collapse;font-size:12px;margin-bottom:6px;background:var(--surface);border-radius:0 0 var(--radius-sm) var(--radius-sm)}
.predictions-table th{text-align:left;padding:10px 12px;font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;font-weight:700;border-bottom:1px solid rgba(255,255,255,0.06);background:var(--elevated)}
.predictions-table td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.04);color:var(--text-dim)}
.predictions-table tbody tr:hover{background:rgba(59,130,246,0.04)}
.value-text{font-weight:600;font-variant-numeric:tabular-nums;color:var(--text)}

/* ===== BOTTOM SECTION GRID ===== */
.bottom-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:28px}

/* ===== ROI SIMULATOR ===== */
.roi-section{background:var(--surface);border:1px solid var(--surface-border);border-radius:var(--radius);padding:20px}
.roi-header{display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none}
.roi-header h3{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:0.6px;color:var(--text)}
.roi-toggle{font-size:10px;color:var(--accent);font-weight:600}
.roi-body{overflow:hidden;max-height:0;transition:max-height 0.3s ease}
.roi-section.open .roi-body{max-height:300px}
.roi-controls{display:flex;gap:20px;padding-top:16px;flex-wrap:wrap}
.roi-field{display:flex;flex-direction:column;gap:4px}
.roi-field label{font-size:10px;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px}
.roi-field input[type=range]{width:180px;accent-color:var(--accent);background:transparent}
.roi-field .roi-val{font-size:13px;font-weight:700;color:var(--accent);font-variant-numeric:tabular-nums}
.roi-result{padding-top:14px;font-size:12px;color:var(--text-dim);line-height:1.6}
.roi-result .highlight{color:var(--accent);font-weight:700}

/* ===== ACCURACY DASHBOARD ===== */
.accuracy-section{background:var(--surface);border:1px solid var(--surface-border);border-radius:var(--radius);padding:20px}
.accuracy-section h3{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:0.6px;margin-bottom:14px;color:var(--text)}
.accuracy-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
.acc-card{background:var(--elevated);border-radius:var(--radius-sm);padding:14px;text-align:center;border:1px solid rgba(255,255,255,0.04)}
.acc-card .acc-sport{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);margin-bottom:6px}
.acc-card .acc-rate{font-size:24px;font-weight:800;font-variant-numeric:tabular-nums}
.acc-card .acc-record{font-size:11px;color:var(--text-dim);margin-top:4px}
.acc-placeholder{text-align:center;padding:24px;color:var(--text-muted);font-size:12px}

/* ===== SKELETON LOADING ===== */
.skeleton{position:relative;overflow:hidden;background:var(--elevated);border-radius:var(--radius-sm)}
.skeleton::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.04),transparent);animation:shimmer 1.5s infinite}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.skel-pick{height:90px;margin-bottom:10px;border-radius:var(--radius)}
.skel-match{height:64px;margin-bottom:6px;border-radius:var(--radius-sm)}
.skel-stat{display:inline-block;width:40px;height:28px;border-radius:4px;vertical-align:middle}
.skel-top{height:200px;flex:0 0 270px;border-radius:var(--radius)}

/* ===== EMPTY STATE ===== */
.empty{text-align:center;padding:40px 20px;color:var(--text-muted);font-size:13px}

/* ===== SECTION TITLE ===== */
.section-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.section-title h2{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:0.6px;color:var(--text)}
.section-title .badge-count{font-size:11px;color:var(--accent);background:var(--accent-soft);padding:3px 10px;border-radius:20px;font-weight:600;font-variant-numeric:tabular-nums}

/* ===== RESPONSIVE ===== */
@media(max-width:1024px){
  .bottom-grid{grid-template-columns:1fr}
}
@media(max-width:768px){
  .header{padding:0 16px;height:50px}
  .header-inner{gap:8px}
  .logo h1{font-size:15px}
  .sport-chips{gap:4px}
  .chip{padding:5px 10px;font-size:11px}
  .date-input{width:110px;font-size:11px}
  .container{padding:0 16px 40px}
  .hero-stats{padding:14px 12px;flex-wrap:wrap;gap:4px}
  .stat-item{padding:8px 16px}
  .stat-item .stat-val{font-size:22px}
  .stat-item:not(:last-child)::after{display:none}
  .top-card{flex:0 0 240px}
  .pick-header{gap:10px;padding:14px 14px 14px 18px}
  .score-ring{width:40px;height:40px;font-size:14px}
  .pick-teams{font-size:13px}
  .pick-analysis{padding:0 14px 10px 18px;font-size:11px}
  .score-breakdown{padding:0 14px 10px 18px}
  .score-breakdown-bars{padding:0 14px 10px 18px}
  .match-card-header{padding:8px 12px;gap:8px}
  .match-tips{padding-left:70px}
  .tab-btn{padding:10px 16px;font-size:12px}
  .bottom-grid{grid-template-columns:1fr}
}
@media(max-width:480px){
  .header-right .date-input{display:none}
  .stat-item{padding:6px 10px}
  .analyst-link span{display:none}
  .carousel-nav{display:none}
  .top-card{flex:0 0 220px;padding:14px}
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-inner">
    <div class="logo">
      <svg width="26" height="26" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="32" height="32" rx="8" fill="rgba(59,130,246,0.15)"/>
        <path d="M7 22L13 12L18 17L25 7" stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M21 7H25V11" stroke="#3b82f6" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M7 25H25" stroke="rgba(59,130,246,0.3)" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <h1>EdgeScore</h1>
    </div>
    <div class="sport-chips" id="sport-chips">
      <button class="chip active" data-sport="">All</button>
      <button class="chip" data-sport="nba">NBA</button>
      <button class="chip" data-sport="nfl">NFL</button>
      <button class="chip" data-sport="nhl">NHL</button>
      <button class="chip" data-sport="mlb">MLB</button>
      <button class="chip" data-sport="ncaab">NCAAB</button>
      <button class="chip" data-sport="football">Soccer</button>
    </div>
    <div class="header-right">
      <a href="/analyst" class="analyst-link"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a7 7 0 0 1 7 7c0 3-2 5.5-4 7l-1 4H10l-1-4c-2-1.5-4-4-4-7a7 7 0 0 1 7-7z"/><line x1="10" y1="22" x2="14" y2="22"/></svg><span>Analyst</span></a>
      <input type="date" class="date-input" id="date-filter" title="Filter by date">
      <div class="health" id="health">
        <div class="health-dot"></div>
        <span>Live</span>
      </div>
    </div>
  </div>
</div>

<div class="container">
  <!-- HERO STATS -->
  <div class="hero-stats" id="stats-bar">
    <div class="stat-item" id="si-preds">
      <span class="stat-val" id="stat-preds"><span class="skeleton skel-stat"></span></span>
      <span class="stat-label">Predictions</span>
    </div>
    <div class="stat-item" id="si-sources">
      <span class="stat-val" id="stat-sources"><span class="skeleton skel-stat"></span></span>
      <span class="stat-label">Active Sources</span>
    </div>
    <div class="stat-item" id="si-matches">
      <span class="stat-val" id="stat-matches"><span class="skeleton skel-stat"></span></span>
      <span class="stat-label">Matches</span>
    </div>
    <div class="stat-item" id="si-sports">
      <span class="stat-val" id="stat-sports"><span class="skeleton skel-stat"></span></span>
      <span class="stat-label">Sports</span>
    </div>
  </div>

  <!-- TOP PICKS CAROUSEL -->
  <div class="carousel-section">
    <div class="carousel-header">
      <h2>Today's Best Picks <span class="badge-count" id="top5-count">--</span></h2>
      <div class="carousel-nav">
        <button class="carousel-btn" id="carousel-prev" title="Previous">&#8249;</button>
        <button class="carousel-btn" id="carousel-next" title="Next">&#8250;</button>
      </div>
    </div>
    <div class="carousel-track" id="top5-grid">
      <div class="skeleton skel-top"></div>
      <div class="skeleton skel-top"></div>
      <div class="skeleton skel-top"></div>
      <div class="skeleton skel-top"></div>
      <div class="skeleton skel-top"></div>
    </div>
  </div>

  <!-- TABBED INTERFACE -->
  <div class="tabs-container">
    <div class="tabs-header" id="tabs-header">
      <button class="tab-btn active" data-tab="all-picks">All Picks</button>
      <button class="tab-btn" data-tab="over-under">Over/Under</button>
      <button class="tab-btn" data-tab="value-bets">Value Bets</button>
      <button class="tab-btn" data-tab="matches">Matches</button>
    </div>

    <!-- TAB: ALL PICKS -->
    <div class="tab-panel active" id="panel-all-picks">
      <div class="conf-filters" id="conf-filters">
        <button class="conf-chip active" data-min="0">All</button>
        <button class="conf-chip" data-min="80">Best Bets 80+</button>
        <button class="conf-chip" data-min="65">High+ 65+</button>
        <button class="conf-chip" data-min="50">Medium+ 50+</button>
      </div>
      <div class="section-title">
        <h2>Scored Predictions</h2>
        <span class="badge-count" id="picks-count">--</span>
      </div>
      <div class="picks-list" id="picks-list">
        <div class="skeleton skel-pick"></div>
        <div class="skeleton skel-pick"></div>
        <div class="skeleton skel-pick"></div>
      </div>
    </div>

    <!-- TAB: OVER/UNDER -->
    <div class="tab-panel" id="panel-over-under">
      <div class="ou-best-row">
        <div class="ou-best-col">
          <div class="ou-best-header over">Best Overs <span class="badge-count" id="ou-best-over-count">--</span></div>
          <div class="ou-best-list" id="ou-best-over"></div>
        </div>
        <div class="ou-best-col">
          <div class="ou-best-header under">Best Unders <span class="badge-count" id="ou-best-under-count">--</span></div>
          <div class="ou-best-list" id="ou-best-under"></div>
        </div>
      </div>
      <div class="section-title" style="margin-top:16px">
        <h2>All Over/Under Predictions</h2>
        <span class="badge-count" id="ou-count">--</span>
      </div>
      <div class="picks-list" id="ou-list">
        <div class="skeleton skel-pick"></div>
        <div class="skeleton skel-pick"></div>
        <div class="skeleton skel-pick"></div>
      </div>
    </div>

    <!-- TAB: VALUE BETS -->
    <div class="tab-panel" id="panel-value-bets">
      <div class="section-title">
        <h2>Positive Expected Value</h2>
        <span class="badge-count" id="value-count">--</span>
      </div>
      <div class="value-cards" id="value-list">
        <div class="skeleton skel-pick"></div>
        <div class="skeleton skel-pick"></div>
        <div class="skeleton skel-pick"></div>
      </div>
    </div>

    <!-- TAB: MATCHES -->
    <div class="tab-panel" id="panel-matches">
      <div class="section-title">
        <h2>Upcoming Matches</h2>
        <span class="badge-count" id="matches-count">--</span>
      </div>
      <div class="matches-list" id="matches-list">
        <div class="skeleton skel-match"></div>
        <div class="skeleton skel-match"></div>
        <div class="skeleton skel-match"></div>
        <div class="skeleton skel-match"></div>
        <div class="skeleton skel-match"></div>
      </div>
    </div>
  </div>

  <!-- BOTTOM: ROI + ACCURACY SIDE BY SIDE -->
  <div class="bottom-grid">
    <div class="roi-section" id="roi-section">
      <div class="roi-header" onclick="document.getElementById('roi-section').classList.toggle('open')">
        <h3>ROI Simulator</h3>
        <span class="roi-toggle">Expand</span>
      </div>
      <div class="roi-body">
        <div class="roi-controls">
          <div class="roi-field">
            <label>Bet Amount ($)</label>
            <input type="range" id="roi-amount" min="5" max="100" value="25" step="5" oninput="updateROI()">
            <span class="roi-val" id="roi-amount-val">$25</span>
          </div>
          <div class="roi-field">
            <label>Min Score Filter</label>
            <input type="range" id="roi-min-score" min="50" max="90" value="65" step="5" oninput="updateROI()">
            <span class="roi-val" id="roi-min-score-val">65+</span>
          </div>
        </div>
        <div class="roi-result" id="roi-result">
          Accuracy data needed to calculate projected ROI. Results will appear once predictions are graded.
        </div>
      </div>
    </div>

    <div class="accuracy-section" id="accuracy-section">
      <h3>Prediction Accuracy</h3>
      <div id="accuracy-grid" class="accuracy-grid">
        <div class="acc-placeholder">Accuracy data will appear once predictions are graded.</div>
      </div>
    </div>
  </div>
</div>

<script>
// ===== STATE =====
const S = {
  sport: '',
  date: '',
  matchPredictions: {},
  lastStatsSig: '',
  lastMatchesSig: '',
  lastPicksSig: '',
  activeTab: 'all-picks',
  ouLoaded: false,
};

const API = '';
const POLL_MS = 30000;
let confMinScore = 0;

// ===== SPORT CONFIG =====
const SPORTS = {
  nba:   { label: 'NBA',   color: '#ea580c', bg: 'rgba(234,88,12,0.1)',  border: 'rgba(234,88,12,0.25)' },
  nfl:   { label: 'NFL',   color: '#3b82f6', bg: 'rgba(59,130,246,0.1)',  border: 'rgba(59,130,246,0.25)' },
  soccer:{ label: 'Soccer',color: '#22c55e', bg: 'rgba(34,197,94,0.1)',  border: 'rgba(34,197,94,0.25)' },
  nhl:   { label: 'NHL',   color: '#06b6d4', bg: 'rgba(6,182,212,0.1)',  border: 'rgba(6,182,212,0.25)' },
  mlb:   { label: 'MLB',   color: '#ef4444', bg: 'rgba(239,68,68,0.1)',  border: 'rgba(239,68,68,0.25)' },
  ncaab: { label: 'NCAAB', color: '#a855f7', bg: 'rgba(168,85,247,0.1)', border: 'rgba(168,85,247,0.25)' },
  football:{ label: 'Football', color: '#22c55e', bg: 'rgba(34,197,94,0.1)', border: 'rgba(34,197,94,0.25)' },
};

function sportConf(s) { return SPORTS[s] || SPORTS.nba; }

// ===== API HELPER =====
async function api(path) {
  const res = await fetch(API + path);
  return res.json();
}

// ===== ESCAPE =====
const _escDiv = document.createElement('div');
function esc(s) { if (!s) return ''; _escDiv.textContent = s; return _escDiv.innerHTML; }

// ===== DATE HELPERS =====
function toDateStr(d) {
  if (!d) return '';
  return String(d).includes('T') ? String(d).split('T')[0] : String(d);
}
function formatDate(d) {
  if (!d) return '';
  const date = new Date(toDateStr(d) + 'T12:00:00');
  const today = new Date(); today.setHours(12,0,0,0);
  const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
  const ds = toDateStr(d);
  if (ds === today.toISOString().split('T')[0]) return 'Today';
  if (ds === tomorrow.toISOString().split('T')[0]) return 'Tomorrow';
  return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
}
function formatShortTime(t) {
  if (!t) return '';
  return t.replace(/:00$/, '');
}

// ===== SCORE TIER =====
function scoreTier(s) {
  if (s >= 80) return 'green';
  if (s >= 65) return 'lime';
  if (s >= 50) return 'amber';
  return 'red';
}
function tierColor(s) {
  if (s >= 80) return '#22c55e';
  if (s >= 65) return '#84cc16';
  if (s >= 50) return '#f59e0b';
  return '#ef4444';
}

// ===== SCORE RING HTML =====
function scoreRingHTML(score, sizeClass) {
  const color = tierColor(score);
  const pct = Math.min(score, 100);
  return `<div class="score-ring ${sizeClass || ''}">
    <div class="score-ring-bg"></div>
    <div class="score-ring-fill" style="background:conic-gradient(${color} calc(${pct}%),transparent 0)"></div>
    <span class="score-ring-val" style="color:${color}">${score}</span>
  </div>`;
}

// ===== SPORT CHIP HANDLERS =====
function applyChipStyle(btn, sport) {
  if (btn.classList.contains('active')) {
    btn.style.background = '#fff';
    btn.style.borderColor = '#fff';
    btn.style.color = sport ? sportConf(sport).color : '#0b0f19';
  } else {
    btn.style.background = '';
    btn.style.borderColor = '';
    btn.style.color = '';
  }
}

document.querySelectorAll('#sport-chips .chip').forEach(btn => {
  btn.onclick = () => {
    S.sport = btn.dataset.sport;
    document.querySelectorAll('#sport-chips .chip').forEach(b => {
      b.classList.remove('active');
      applyChipStyle(b, b.dataset.sport);
    });
    btn.classList.add('active');
    applyChipStyle(btn, btn.dataset.sport);
    loadAll();
  };
  applyChipStyle(btn, btn.dataset.sport);
});

// ===== DATE FILTER =====
document.getElementById('date-filter').addEventListener('change', e => {
  S.date = e.target.value;
  loadAll();
});

// ===== TABS =====
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    S.activeTab = btn.dataset.tab;
    document.getElementById('panel-' + btn.dataset.tab).classList.add('active');
    // lazy load tabs on first switch
    if (btn.dataset.tab === 'value-bets' && !S.valueBetsLoaded) {
      loadValueBets();
    }
    if (btn.dataset.tab === 'over-under' && !S.ouLoaded) {
      loadOverUnder();
    }
  };
});

// ===== CONFIDENCE FILTER =====
document.querySelectorAll('#conf-filters .conf-chip').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('#conf-filters .conf-chip').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    confMinScore = parseInt(btn.dataset.min || '0', 10);
    applyConfFilter();
  };
});

function applyConfFilter() {
  document.querySelectorAll('.pick-card').forEach(card => {
    const score = parseInt(card.dataset.score || '0', 10);
    card.style.display = score >= confMinScore ? '' : 'none';
  });
}

// ===== CAROUSEL NAV =====
document.getElementById('carousel-prev').onclick = () => {
  const track = document.getElementById('top5-grid');
  track.scrollBy({ left: -284, behavior: 'smooth' });
};
document.getElementById('carousel-next').onclick = () => {
  const track = document.getElementById('top5-grid');
  track.scrollBy({ left: 284, behavior: 'smooth' });
};

// ===== STATS =====
async function loadStats() {
  const s = await api('/predictions/stats');
  const sig = JSON.stringify(s);
  const changed = S.lastStatsSig && sig !== S.lastStatsSig;
  S.lastStatsSig = sig;

  animateValue('stat-preds', s.total_predictions || 0);
  animateValue('stat-sources', s.active_sources || 0);
  animateValue('stat-matches', s.total_matches || 0);
  animateValue('stat-sports', (s.bySport || []).length || 0);

  if (changed) {
    document.querySelectorAll('.stat-item').forEach(el => {
      el.classList.remove('updated');
      void el.offsetWidth;
      el.classList.add('updated');
    });
  }
  return changed;
}


function animateValue(id, target) {
  const el = document.getElementById(id);
  const current = parseInt(el.textContent) || 0;
  if (current === target) { el.textContent = target.toLocaleString(); return; }
  const diff = target - current;
  const steps = Math.min(Math.abs(diff), 20);
  const stepTime = 300 / steps;
  let i = 0;
  const timer = setInterval(() => {
    i++;
    const progress = i / steps;
    const val = Math.round(current + diff * progress);
    el.textContent = val.toLocaleString();
    if (i >= steps) clearInterval(timer);
  }, stepTime);
}

// ===== BREAKDOWN BARS COLORS =====
const BREAKDOWN_COLORS = {
  sourceAgreement: '#3b82f6',
  confidence: '#f59e0b',
  margin: '#22c55e',
  value: '#a855f7',
  sourceAccuracy: '#e879f9',
  alignment: '#06b6d4',
  form: '#ea580c',
  h2h: '#ef4444',
  homeAdvantage: '#84cc16'
};
const BREAKDOWN_MAXES = {
  sourceAgreement: 20,
  confidence: 30,
  margin: 25,
  value: 20,
  sourceAccuracy: 15,
  alignment: 10,
  form: 10,
  h2h: 5,
  homeAdvantage: 5
};
const BREAKDOWN_LABELS = {
  sourceAgreement: 'Sources',
  confidence: 'Confidence',
  margin: 'Margin',
  value: 'Value',
  sourceAccuracy: 'Accuracy',
  alignment: 'Alignment',
  form: 'Form',
  h2h: 'H2H',
  homeAdvantage: 'Home Adv'
};

function breakdownBarsHTML(bd) {
  if (!bd) return '';
  const keys = ['sourceAgreement','confidence','margin','value','sourceAccuracy','alignment','form','h2h','homeAdvantage'];
  // These keys only show when > 0 (0 means no data available, not a real score)
  const hideWhenZero = new Set(['form','h2h','homeAdvantage','alignment']);
  let html = '';
  for (const key of keys) {
    const val = bd[key];
    if (val == null) continue;
    if (val === 0 && hideWhenZero.has(key)) continue;
    const max = BREAKDOWN_MAXES[key] || 20;
    const pct = Math.min((val / max) * 100, 100);
    const color = BREAKDOWN_COLORS[key];
    const label = BREAKDOWN_LABELS[key];
    html += `<div class="breakdown-row">
      <span class="breakdown-label">${label}</span>
      <div class="breakdown-bar-track"><div class="breakdown-bar-fill" style="width:${pct}%;background:${color}"></div></div>
      <span class="breakdown-score">${val}/${max}</span>
    </div>`;
  }
  return html;
}

function breakdownBarsFromPick(p) {
  const bd = {
    sourceAgreement: p.sourceAgreement,
    confidence: p.confidenceScore,
    margin: p.marginScore,
    value: p.valueScore,
    sourceAccuracy: p.sourceAccuracy,
    alignment: p.alignmentScore,
  };
  if (p.formScore) bd.form = p.formScore;
  if (p.h2hScore) bd.h2h = p.h2hScore;
  if (p.homeAdvantage) bd.homeAdvantage = p.homeAdvantage;
  return breakdownBarsHTML(bd);
}

// ===== TOP 5 PICKS (CAROUSEL) =====
async function loadTop5() {
  const grid = document.getElementById('top5-grid');
  const params = new URLSearchParams();
  if (S.sport) params.set('sport', S.sport);
  if (S.date) params.set('date', S.date);
  params.set('limit', '5');
  const res = await api('/predictions/top-picks?' + params.toString());
  const picks = res.data || [];

  document.getElementById('top5-count').textContent = picks.length ? `Top ${picks.length}` : '--';

  if (!picks.length) {
    grid.innerHTML = '<div class="empty" style="flex:1;min-width:260px">No top picks available yet.</div>';
    return;
  }

  grid.innerHTML = '';
  for (const p of picks) {
    grid.appendChild(createTopCard(p));
  }
}

function createTopCard(p) {
  const card = document.createElement('div');
  card.className = 'top-card';
  card.dataset.sport = p.sport;

  const conf = sportConf(p.sport);
  const bd = p.breakdown;
  const evBadge = p.ev ? `<span class="ev-badge">+${(p.ev * 100).toFixed(0)}% EV</span>` : '';

  card.innerHTML = `
    <div class="top-card-rank">#${p.rank}</div>
    <div class="top-card-head">
      ${scoreRingHTML(p.score)}
      <div class="top-card-info">
        <div class="top-card-match">${esc(p.match)}</div>
        <div class="top-card-meta">
          <span class="sport-badge" style="background:${conf.bg};color:${conf.color}">${conf.label}</span>
          <span style="font-size:11px;color:var(--text-muted)">${formatDate(p.date)}</span>
        </div>
      </div>
    </div>
    <div class="top-card-pills">
      <span class="rec-pill side-${p.pick}">${p.pick}</span>
      ${evBadge}
    </div>
    <div class="top-card-analysis">${esc(p.analysis)}</div>
    <div class="top-card-detail">
      <div class="top-card-sources">
        ${breakdownBarsHTML(bd)}
      </div>
    </div>
  `;

  card.onclick = () => card.classList.toggle('expanded');
  return card;
}

// ===== BEST PICKS =====
async function loadPicks() {
  const grid = document.getElementById('picks-list');
  const params = new URLSearchParams();
  if (S.sport) params.set('sport', S.sport);
  if (S.date) params.set('date', S.date);
  const res = await api('/predictions/best-multis?' + params.toString());
  const filtered = (res.data || []).filter(d => d.picks.length > 0);

  const filteredTotal = filtered.reduce((n, d) => n + d.picks.length, 0);
  document.getElementById('picks-count').textContent = `${filteredTotal} picks`;

  const sig = JSON.stringify(filtered.map(d => d.date + d.picks.map(p => p.matchId + p.score).join()));
  if (S.lastPicksSig && sig === S.lastPicksSig) return false;
  S.lastPicksSig = sig;

  if (!filtered.length) {
    grid.innerHTML = '<div class="empty">No analyzed picks available yet.</div>';
    return true;
  }

  grid.innerHTML = '';
  for (const day of filtered) {
    const divider = document.createElement('div');
    divider.className = 'date-divider';
    divider.innerHTML = `${formatDate(day.date)} <span class="pick-count">${day.picks.length}</span>`;
    grid.appendChild(divider);

    for (const p of day.picks) {
      grid.appendChild(createPickCard(p));
    }
  }
  applyConfFilter();
  return true;
}

function createPickCard(p) {
  const card = document.createElement('div');
  card.className = 'pick-card';
  card.dataset.sport = p.sport;
  card.dataset.score = p.score;

  const conf = sportConf(p.sport);
  const teamName = p.recommendation === 'home' ? p.homeTeam : p.recommendation === 'away' ? p.awayTeam : 'Draw';
  const pickLabel = p.pickType === 'moneyline' ? teamName + ' ML'
    : p.pickType === 'spread' ? teamName + ' Spread'
    : p.pickType.replace('_', ' ');
  const oddsText = p.bestOdds ? `${p.bestOdds.toFixed(2)}x` : '';
  const probText = p.impliedProb ? `${p.impliedProb}%` : '';
  const evBadge = p.ev ? `<span class="ev-badge">+${(p.ev * 100).toFixed(0)}% EV</span>` : '';

  card.innerHTML = `
    <div class="pick-header">
      ${scoreRingHTML(p.score)}
      <div class="pick-info">
        <div class="pick-teams">${esc(p.homeTeam)}<span class="vs">vs</span>${esc(p.awayTeam)}</div>
        <div class="pick-meta">
          <span class="sport-badge" style="background:${conf.bg};color:${conf.color}">${conf.label}</span>
          ${p.gameTime ? '<span>' + esc(formatShortTime(p.gameTime)) + '</span>' : ''}
          ${oddsText ? '<span>' + oddsText + '</span>' : ''}
          ${probText ? '<span>' + probText + ' implied</span>' : ''}
        </div>
      </div>
      <div class="pick-right">
        <span class="rec-pill side-${p.recommendation}">${esc(pickLabel)}</span>
        ${evBadge}
        ${oddsText ? `<span class="pick-odds">${oddsText}</span>` : ''}
      </div>
    </div>
    ${p.analysis ? `<div class="pick-analysis">${esc(p.analysis)}</div>` : ''}
    <div class="score-breakdown">
      <span class="score-dot"><span class="dot" style="background:#3b82f6"></span>${p.sourceAgreement}<span class="tooltip">Sources: ${p.sourceAgreement}/20</span></span>
      <span class="score-dot"><span class="dot" style="background:#f59e0b"></span>${p.confidenceScore}<span class="tooltip">Confidence: ${p.confidenceScore}/30</span></span>
      <span class="score-dot"><span class="dot" style="background:#22c55e"></span>${p.marginScore}<span class="tooltip">Margin: ${p.marginScore}/25</span></span>
      <span class="score-dot"><span class="dot" style="background:#a855f7"></span>${p.valueScore}<span class="tooltip">Value: ${p.valueScore}/20</span></span>
      <span class="score-dot"><span class="dot" style="background:#e879f9"></span>${p.sourceAccuracy}<span class="tooltip">Accuracy: ${p.sourceAccuracy}/15</span></span>
      ${p.alignmentScore ? `<span class="score-dot"><span class="dot" style="background:#06b6d4"></span>${p.alignmentScore}<span class="tooltip">Alignment: ${p.alignmentScore}/10</span></span>` : ''}
      ${p.formScore ? `<span class="score-dot"><span class="dot" style="background:#ea580c"></span>${p.formScore}<span class="tooltip">Form: ${p.formScore}/10</span></span>` : ''}
      ${p.h2hScore ? `<span class="score-dot"><span class="dot" style="background:#ef4444"></span>${p.h2hScore}<span class="tooltip">H2H: ${p.h2hScore}/5</span></span>` : ''}
      ${p.homeAdvantage ? `<span class="score-dot"><span class="dot" style="background:#84cc16"></span>${p.homeAdvantage}<span class="tooltip">Home Adv: ${p.homeAdvantage}/5</span></span>` : ''}
    </div>
    <div class="score-breakdown-bars">
      ${breakdownBarsFromPick(p)}
    </div>
    <div class="pick-detail">
      ${p.sources && p.sources.length ? `<div style="padding:8px 22px 14px;display:flex;flex-wrap:wrap;gap:4px">${p.sources.map(s => `<span class="source-chip">${esc(s.name)}${s.detail ? '  ' + esc(s.detail) : ''}</span>`).join('')}</div>` : ''}
    </div>
  `;

  card.onclick = () => {
    card.classList.toggle('expanded');
  };

  return card;
}

// ===== OVER/UNDER =====
async function loadOverUnder() {
  S.ouLoaded = true;
  const grid = document.getElementById('ou-list');
  const params = new URLSearchParams();
  if (S.sport) params.set('sport', S.sport);
  if (S.date) params.set('date', S.date);

  try {
    const res = await api('/predictions/over-under?' + params.toString());
    const items = res.data || [];

    document.getElementById('ou-count').textContent = items.length ? `${items.length} matches` : '--';

    // Populate best overs & best unders
    populateBestOU(items);

    if (!items.length) {
      grid.innerHTML = '<div class="empty">No over/under predictions found for this date/sport.</div>';
      return;
    }

    grid.innerHTML = '';
    for (const m of items) {
      grid.appendChild(createOUCard(m));
    }
  } catch {
    grid.innerHTML = '<div class="empty">Unable to load over/under predictions.</div>';
  }
}

function populateBestOU(items) {
  const overGrid = document.getElementById('ou-best-over');
  const underGrid = document.getElementById('ou-best-under');

  // Rank: prefer higher source count, then higher consensus %, non-split only
  const rank = (arr) => arr
    .filter(m => m.consensus !== 'split' && m.total >= 2)
    .sort((a, b) => {
      const aPct = a.consensusCount / a.total;
      const bPct = b.consensusCount / b.total;
      if (b.total !== a.total) return b.total - a.total;
      return bPct - aPct;
    });

  const bestOvers = rank(items.filter(m => m.consensus === 'over')).slice(0, 5);
  const bestUnders = rank(items.filter(m => m.consensus === 'under')).slice(0, 5);

  document.getElementById('ou-best-over-count').textContent = bestOvers.length ? `Top ${bestOvers.length}` : '--';
  document.getElementById('ou-best-under-count').textContent = bestUnders.length ? `Top ${bestUnders.length}` : '--';

  overGrid.innerHTML = bestOvers.length
    ? bestOvers.map((m, i) => createBestOUCardHTML(m, i + 1, 'over')).join('')
    : '<div class="empty" style="font-size:12px">No strong over picks yet.</div>';

  underGrid.innerHTML = bestUnders.length
    ? bestUnders.map((m, i) => createBestOUCardHTML(m, i + 1, 'under')).join('')
    : '<div class="empty" style="font-size:12px">No strong under picks yet.</div>';
}

function createBestOUCardHTML(m, rank, side) {
  const conf = sportConf(m.sport);
  const sources = m.sources.filter(s => s.side === side);
  const lineText = m.line != null ? (side === 'over' ? 'O ' : 'U ') + m.line : side;
  return `
    <div class="ou-best-card ${side}">
      <div class="ou-best-rank">#${rank}</div>
      <div class="ou-best-match">${esc(m.match)}</div>
      <div class="ou-best-meta">
        <span class="sport-badge" style="background:${conf.bg};color:${conf.color};font-size:9px;padding:2px 6px">${conf.label}</span>
        <span class="ou-best-line ${side}">${lineText}</span>
        <span class="ou-best-consensus">${m.consensusCount}/${m.total} sources agree</span>
      </div>
      <div class="ou-best-sources">
        ${sources.map(s => `<span class="ou-best-src">${esc(s.source)}${s.value != null ? '  ' + s.value : ''}</span>`).join('')}
      </div>
    </div>
  `;
}

function createOUCard(m) {
  const card = document.createElement('div');
  card.className = 'ou-card';
  card.dataset.sport = m.sport;

  const conf = sportConf(m.sport);
  const overPct = m.total > 0 ? Math.round((m.overCount / m.total) * 100) : 50;
  const underPct = 100 - overPct;
  const lineText = m.line != null ? m.line : '--';

  card.innerHTML = `
    <div class="ou-card-head">
      <div class="ou-card-match">
        <div class="ou-card-match-name">${esc(m.match)}</div>
        <div class="ou-card-meta">
          <span class="sport-badge" style="background:${conf.bg};color:${conf.color}">${conf.label}</span>
          <span>${formatDate(m.date)}</span>
          ${m.gameTime ? '<span>' + esc(formatShortTime(m.gameTime)) + '</span>' : ''}
        </div>
      </div>
      <div class="ou-line">${lineText}</div>
      <div class="ou-consensus">
        <span class="ou-consensus-side ${m.consensus}">${m.consensus}</span>
        <span class="ou-consensus-count">${m.consensusCount}/${m.total} sources</span>
      </div>
    </div>
    <div class="ou-bar-wrap">
      <span class="ou-bar-label over">Over ${m.overCount}</span>
      <div class="ou-bar-track">
        <div class="ou-bar-fill-over" style="width:${overPct}%"></div>
        <div class="ou-bar-fill-under" style="width:${underPct}%"></div>
      </div>
      <span class="ou-bar-label under">Under ${m.underCount}</span>
    </div>
    <div class="ou-sources">
      ${m.sources.map(s => `<span class="ou-source-chip ${s.side}">${esc(s.source)}  ${s.side}${s.value != null ? ' ' + s.value : ''}</span>`).join('')}
    </div>
  `;

  card.onclick = () => card.classList.toggle('expanded');
  return card;
}

// ===== VALUE BETS =====
async function loadValueBets() {
  S.valueBetsLoaded = true;
  const grid = document.getElementById('value-list');
  const params = new URLSearchParams();
  if (S.sport) params.set('sport', S.sport);
  if (S.date) params.set('date', S.date);
  params.set('limit', '50');

  try {
    const res = await api('/predictions/value-bets?' + params.toString());
    const picks = res.data || [];

    document.getElementById('value-count').textContent = picks.length ? `${picks.length} bets` : '--';

    if (!picks.length) {
      grid.innerHTML = '<div class="empty">No value bets found for this date/sport combination.</div>';
      return;
    }

    grid.innerHTML = '';
    for (const p of picks) {
      grid.appendChild(createValueCard(p));
    }
  } catch {
    grid.innerHTML = '<div class="empty">Unable to load value bets.</div>';
  }
}

function createValueCard(p) {
  const card = document.createElement('div');
  card.className = 'value-card';

  const conf = sportConf(p.sport);
  const evPct = p.ev != null ? (p.ev * 100).toFixed(0) : (p.edge != null ? p.edge.toFixed(0) : '?');
  const estProb = p.estimatedProb != null ? (p.estimatedProb * 100).toFixed(1) + '%' : (p.implied_prob || '--');
  const marketProb = p.marketProb != null ? (p.marketProb * 100).toFixed(1) + '%' : (p.market_prob || '--');
  const edge = p.edge != null ? p.edge.toFixed(1) + '%' : '--';
  const matchName = p.match || ((p.homeTeam || p.home_team || '') + ' vs ' + (p.awayTeam || p.away_team || ''));
  const side = p.pick || p.side || p.recommendation || '';
  const pickType = p.pickType || p.pick_type || '';
  const oddsVal = p.bestOdds || p.best_odds || p.odds;
  const analysis = p.analysis || p.reason || '';

  card.innerHTML = `
    <div class="value-card-head">
      <div>
        <div class="value-card-match">${esc(matchName)}</div>
      </div>
      <div class="value-card-ev">+${evPct}%</div>
    </div>
    <div class="value-card-pills">
      <span class="sport-badge" style="background:${conf.bg};color:${conf.color}">${conf.label}</span>
      ${side ? `<span class="rec-pill side-${side}">${esc(side)}</span>` : ''}
      ${pickType ? `<span style="font-size:10px;color:var(--text-muted);text-transform:uppercase">${esc(pickType.replace('_',' '))}</span>` : ''}
    </div>
    <div class="value-metrics">
      <div class="value-metric">
        <span class="value-metric-label">Est. Prob</span>
        <span class="value-metric-val">${estProb}</span>
      </div>
      <div class="value-metric">
        <span class="value-metric-label">Market Prob</span>
        <span class="value-metric-val">${marketProb}</span>
      </div>
      <div class="value-metric">
        <span class="value-metric-label">Edge</span>
        <span class="value-metric-val" style="color:var(--success)">${edge}</span>
      </div>
    </div>
    ${analysis ? `<div class="value-card-analysis">${esc(analysis)}</div>` : ''}
    ${oddsVal ? `<div class="value-card-odds">Best Odds: ${Number(oddsVal).toFixed(2)}x</div>` : ''}
  `;

  card.onclick = () => card.classList.toggle('expanded');
  return card;
}

// ===== MATCHES =====
async function loadMatches(silent = false) {
  const grid = document.getElementById('matches-list');
  if (!silent && !grid.querySelector('.match-card')) {
    grid.innerHTML = '<div class="skeleton skel-match"></div>'.repeat(5);
  }

  const params = new URLSearchParams();
  if (S.sport) params.set('sport', S.sport);
  if (S.date) params.set('date', S.date);

  const res = await api('/predictions/matches?' + params.toString());
  const matches = res.data || [];
  const sig = JSON.stringify(matches.map(m => m.id + ':' + m.prediction_count));
  const changed = S.lastMatchesSig && sig !== S.lastMatchesSig;
  S.lastMatchesSig = sig;

  if (silent && !changed) return false;

  document.getElementById('matches-count').textContent = `${matches.length} matches`;

  if (!matches.length) {
    grid.innerHTML = '<div class="empty">No matches found.</div>';
    return changed;
  }

  const expandedId = grid.querySelector('.match-card.expanded')?.dataset.matchId;

  grid.innerHTML = '';
  let lastDate = '';
  for (const m of matches) {
    const dateStr = formatDate(toDateStr(m.game_date));
    if (dateStr !== lastDate) {
      lastDate = dateStr;
      const divider = document.createElement('div');
      divider.className = 'date-divider';
      divider.textContent = dateStr;
      grid.appendChild(divider);
    }
    const { row, detailWrap } = createMatchRow(m);
    grid.appendChild(row);
    grid.appendChild(detailWrap);
  }

  if (expandedId) {
    const row = grid.querySelector(`.match-card[data-match-id="${expandedId}"]`);
    if (row) toggleMatchRow(row, expandedId);
  }

  return changed;
}

function summarizeTips(tips, homeAbbr, awayAbbr) {
  if (!tips || !tips.length) return [];
  const priority = ['moneyline', 'over_under', 'prop', 'spread'];
  const byType = {};
  for (const t of tips) {
    if (!byType[t.pick_type]) byType[t.pick_type] = [];
    byType[t.pick_type].push(t);
  }
  const pills = [];
  for (const type of priority) {
    if (pills.length >= 3) break;
    const entries = byType[type];
    if (!entries) continue;
    entries.sort((a, b) => b.count - a.count);
    const top = entries[0];
    let label, sideClass;
    if (type === 'moneyline') {
      const name = top.side === 'home' ? (homeAbbr || 'HOME') : top.side === 'away' ? (awayAbbr || 'AWAY') : 'DRAW';
      label = top.count > 1 ? name + ' x' + top.count : name;
      sideClass = 'side-' + top.side;
    } else if (type === 'over_under') {
      const dir = top.side === 'over' ? 'Over' : 'Under';
      label = top.avg_value != null ? dir + ' ' + top.avg_value : dir;
      sideClass = 'side-' + top.side;
    } else if (type === 'prop') {
      label = 'BTTS ' + (top.side === 'yes' ? 'Yes' : 'No');
      sideClass = 'side-' + top.side;
    } else if (type === 'spread') {
      const name = top.side === 'home' ? (homeAbbr || 'HOME') : (awayAbbr || 'AWAY');
      label = name + ' Sprd';
      sideClass = 'side-' + top.side;
    }
    pills.push({ label, sideClass });
  }
  return pills;
}

function createMatchRow(m) {
  const conf = sportConf(m.sport);

  const card = document.createElement('div');
  card.className = 'match-card';
  card.dataset.matchId = m.id;

  const tips = typeof m.tips === 'string' ? JSON.parse(m.tips) : (m.tips || []);
  const pills = summarizeTips(tips, m.home_abbr, m.away_abbr);
  const pillsHtml = pills.map(p =>
    `<span class="match-tip ${p.sideClass}">${esc(p.label)}</span>`
  ).join('');

  card.innerHTML = `
    <div class="match-card-header">
      <span class="sport-dot" style="background:${conf.color}"></span>
      <span class="match-time-col">${esc(formatShortTime(m.game_time) || '--')}</span>
      <span class="match-teams-col">${esc(m.home_team)}<span class="vs">vs</span>${esc(m.away_team)}</span>
      <span class="match-picks-count">${m.prediction_count} tips</span>
      <span class="match-chevron">&#9654;</span>
    </div>
    ${pillsHtml ? `<div class="match-tips">${pillsHtml}</div>` : ''}
  `;

  const detailWrap = document.createElement('div');
  detailWrap.className = 'match-detail-wrap';
  detailWrap.innerHTML = `<div class="match-detail" id="mdetail-${m.id}"></div>`;

  card.onclick = () => toggleMatchRow(card, m.id);

  return { row: card, detailWrap };
}

async function toggleMatchRow(row, matchId) {
  const wasExpanded = row.classList.contains('expanded');

  document.querySelectorAll('.match-card.expanded').forEach(r => r.classList.remove('expanded'));

  if (wasExpanded) return;

  row.classList.add('expanded');
  const container = document.getElementById('mdetail-' + matchId);

  if (S.matchPredictions[matchId]) {
    renderMatchPredictions(container, S.matchPredictions[matchId]);
    return;
  }

  container.innerHTML = '<div style="padding:16px;text-align:center;color:var(--text-muted);font-size:12px">Loading...</div>';
  const res = await api('/predictions/' + matchId);
  S.matchPredictions[matchId] = res.data || [];
  renderMatchPredictions(container, S.matchPredictions[matchId]);
}

function renderMatchPredictions(container, preds) {
  if (!preds.length) {
    container.innerHTML = '<div style="padding:14px;text-align:center;color:var(--text-muted);font-size:12px">No predictions</div>';
    return;
  }
  let rows = '';
  for (const p of preds) {
    const confP = p.confidence ? `<span class="conf-pill conf-${p.confidence}">${p.confidence.replace('_', ' ')}</span>` : '';
    const val = p.value != null ? p.value : '--';
    const isOU = p.side === 'over' || p.side === 'under';
    const sideLabel = isOU && val !== '--' ? `${p.side} ${val}` : p.side;
    const valDisplay = isOU && val !== '--' ? '' : val;
    rows += `<tr>
      <td style="font-size:11px">${p.pick_type.replace('_', ' ')}</td>
      <td><span class="side-pill side-${p.side}">${sideLabel}</span></td>
      <td class="value-text">${valDisplay}</td>
      <td>${confP}</td>
      <td style="color:var(--text-muted);font-size:11px">${esc(p.picker_name)}</td>
    </tr>`;
  }
  container.innerHTML = `<table class="predictions-table">
    <thead><tr><th>Type</th><th>Side</th><th>Value</th><th>Conf</th><th>Picker</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

// ===== HEALTH =====
async function checkHealth() {
  try {
    const h = await api('/health');
    const el = document.getElementById('health');
    const dot = el.querySelector('.health-dot');
    const txt = el.querySelector('span');
    if (h.status === 'healthy') {
      dot.style.background = '#22c55e';
      dot.style.boxShadow = '0 0 6px rgba(34,197,94,0.6)';
      txt.textContent = 'Live';
    } else {
      dot.style.background = '#fbbf24';
      dot.style.boxShadow = '0 0 6px rgba(251,191,36,0.6)';
      txt.textContent = 'Degraded';
    }
  } catch {
    const el = document.getElementById('health');
    el.querySelector('.health-dot').style.background = '#ef4444';
    el.querySelector('.health-dot').style.boxShadow = '0 0 6px rgba(239,68,68,0.6)';
    el.querySelector('span').textContent = 'Offline';
  }
}

// ===== LOAD ALL =====
async function loadAll() {
  await Promise.all([loadStats(), loadTop5(), loadPicks(), loadMatches(), checkHealth()]);
  // Reload lazy tabs if already visited
  if (S.valueBetsLoaded) loadValueBets();
  if (S.ouLoaded) loadOverUnder();
}

// ===== POLL =====
async function poll() {
  try {
    const [statsChanged, , , matchesChanged] = await Promise.all([
      loadStats(),
      loadTop5(),
      loadPicks(),
      loadMatches(true),
    ]);
    if (statsChanged || matchesChanged) S.matchPredictions = {};
  } catch (e) {}
}

// ===== WEBSOCKET =====
let ws = null;
let wsRetryMs = 1000;

function connectWS() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws`);
  ws.onopen = () => {
    wsRetryMs = 1000;
    const el = document.getElementById('health');
    const txt = el.querySelector('span');
    txt.textContent = 'Live (WS)';
  };
  ws.onmessage = (ev) => {
    try {
      const msg = JSON.parse(ev.data);
      if (msg.event === 'predictions:updated') {
        poll();
      }
    } catch {}
  };
  ws.onclose = () => {
    const el = document.getElementById('health');
    const txt = el.querySelector('span');
    txt.textContent = 'Reconnecting...';
    setTimeout(connectWS, wsRetryMs);
    wsRetryMs = Math.min(wsRetryMs * 2, 30000);
  };
  ws.onerror = () => ws.close();
}

// ===== ROI SIMULATOR =====
let accuracyData = null;

function updateROI() {
  const amount = parseInt(document.getElementById('roi-amount').value);
  const minScore = parseInt(document.getElementById('roi-min-score').value);
  document.getElementById('roi-amount-val').textContent = '$' + amount;
  document.getElementById('roi-min-score-val').textContent = minScore + '+';

  const el = document.getElementById('roi-result');
  if (!accuracyData || !accuracyData.length) {
    el.innerHTML = 'Accuracy data needed to calculate projected ROI. Results will appear once predictions are graded.';
    return;
  }
  const total = accuracyData.reduce((s, d) => s + (d.wins || 0) + (d.losses || 0), 0);
  const wins = accuracyData.reduce((s, d) => s + (d.wins || 0), 0);
  if (total < 10) {
    el.innerHTML = `Only <span class="highlight">${total}</span> graded picks so far. Need at least 10 for meaningful projections.`;
    return;
  }
  const winRate = wins / total;
  const avgOdds = 1.91;
  const projectedPerBet = (winRate * avgOdds - 1) * amount;
  const daily = projectedPerBet * 3;
  el.innerHTML = `Based on <span class="highlight">${(winRate * 100).toFixed(1)}%</span> win rate across <span class="highlight">${total}</span> picks at $${amount}/bet:<br>` +
    `Projected per bet: <span class="highlight">$${projectedPerBet.toFixed(2)}</span> | ` +
    `Daily (~3 picks): <span class="highlight">$${daily.toFixed(2)}</span> | ` +
    `Monthly: <span class="highlight">$${(daily * 30).toFixed(0)}</span>`;
}

// ===== ACCURACY DASHBOARD =====
async function loadAccuracy() {
  try {
    const res = await api('/predictions/accuracy');
    accuracyData = res.data || [];
    const grid = document.getElementById('accuracy-grid');

    if (!accuracyData.length) {
      grid.innerHTML = '<div class="acc-placeholder">Accuracy data will appear once predictions are graded.</div>';
      return;
    }

    const bySport = {};
    for (const d of accuracyData) {
      if (!bySport[d.sport]) bySport[d.sport] = { wins: 0, losses: 0, pushes: 0 };
      bySport[d.sport].wins += d.wins || 0;
      bySport[d.sport].losses += d.losses || 0;
      bySport[d.sport].pushes += d.pushes || 0;
    }

    grid.innerHTML = '';
    for (const [sport, data] of Object.entries(bySport)) {
      const decided = data.wins + data.losses;
      const rate = decided > 0 ? ((data.wins / decided) * 100).toFixed(1) : '--';
      const conf = sportConf(sport);
      const rateColor = decided > 0 ? (data.wins / decided >= 0.55 ? 'var(--success)' : data.wins / decided >= 0.5 ? 'var(--amber)' : 'var(--danger)') : 'var(--text-muted)';
      const card = document.createElement('div');
      card.className = 'acc-card';
      card.innerHTML = `
        <div class="acc-sport" style="color:${conf.color}">${conf.label}</div>
        <div class="acc-rate" style="color:${rateColor}">${rate}%</div>
        <div class="acc-record">${data.wins}W - ${data.losses}L - ${data.pushes}P</div>
      `;
      grid.appendChild(card);
    }

    updateROI();
  } catch {}
}

// ===== INIT =====
(async () => {
  await loadAll();
  loadAccuracy();
  connectWS();
  setInterval(checkHealth, POLL_MS);
  setInterval(poll, POLL_MS);
  setInterval(loadAccuracy, 300000);

  // Register service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
  }
})();
</script>
</body>
</html>
