<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bet Aggregator</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0a0f;--bg2:#12121a;--surface:rgba(255,255,255,0.04);
  --border:rgba(255,255,255,0.08);--border-hover:rgba(255,255,255,0.15);
  --text:#e2e8f0;--text-dim:#94a3b8;--text-muted:#64748b;
  --accent:#3b82f6;--accent-glow:rgba(59,130,246,0.15);
  --nba:#f97316;--football:#22c55e;
  --home:#3b82f6;--away:#ef4444;--draw:#a855f7;
  --over:#22c55e;--under:#f97316;--yes:#10b981;--no:#f43f5e;
  --best-bet:#eab308;--high:#22c55e;--medium:#3b82f6;--low:#64748b;
  --radius:12px;--radius-sm:8px;--radius-xs:6px;
}
html{font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text)}
body{min-height:100vh;background:radial-gradient(ellipse at 50% 0%,rgba(59,130,246,0.08) 0%,transparent 60%)}
a{color:var(--accent);text-decoration:none}

/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* Layout */
.container{max-width:1200px;margin:0 auto;padding:0 20px}
header{padding:20px 0;border-bottom:1px solid var(--border)}
.header-inner{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
.logo{display:flex;align-items:center;gap:12px}
.logo h1{font-size:20px;font-weight:700;letter-spacing:-0.5px}
.logo span{font-size:12px;color:var(--text-muted);font-weight:400;background:var(--surface);padding:3px 8px;border-radius:var(--radius-xs);border:1px solid var(--border)}
.health{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-dim)}
.health-dot{width:8px;height:8px;border-radius:50%;background:#22c55e;box-shadow:0 0 8px rgba(34,197,94,0.5);animation:pulse 2s infinite}
.last-updated{font-size:11px;color:var(--text-muted);margin-left:4px}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
@keyframes flash-update{0%{background:rgba(59,130,246,0.12)}100%{background:var(--surface)}}
.stat-card.updated{animation:flash-update 1s ease-out}

/* Filters */
.filters{padding:16px 0;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.filter-group{display:flex;gap:4px}
.filter-btn{padding:6px 14px;font-size:13px;font-weight:500;border:1px solid var(--border);border-radius:var(--radius-xs);background:var(--surface);color:var(--text-dim);cursor:pointer;transition:all 0.2s}
.filter-btn:hover{border-color:var(--border-hover);color:var(--text)}
.filter-btn.active{background:var(--accent-glow);border-color:var(--accent);color:var(--accent)}
.filter-btn.sport-nba.active{background:rgba(249,115,22,0.12);border-color:var(--nba);color:var(--nba)}
.filter-btn.sport-football.active{background:rgba(34,197,94,0.12);border-color:var(--football);color:var(--football)}
input[type=date]{padding:6px 12px;font-size:13px;border:1px solid var(--border);border-radius:var(--radius-xs);background:var(--surface);color:var(--text);font-family:inherit}
input[type=date]::-webkit-calendar-picker-indicator{filter:invert(0.7)}

/* Stats */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;padding:20px 0}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px;backdrop-filter:blur(10px)}
.stat-card .label{font-size:12px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px}
.stat-card .value{font-size:28px;font-weight:700;letter-spacing:-1px}
.stat-card .sub{font-size:12px;color:var(--text-dim);margin-top:2px}

/* Match Cards */
.matches-header{display:flex;align-items:center;justify-content:space-between;padding:8px 0 12px}
.matches-header h2{font-size:16px;font-weight:600;color:var(--text-dim)}
.matches-header .count{font-size:13px;color:var(--text-muted)}
.matches-grid{display:grid;gap:8px;padding-bottom:40px}
.match-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;transition:border-color 0.2s,background 0.2s;cursor:pointer}
.match-card:hover{border-color:var(--border-hover);background:rgba(255,255,255,0.06)}
.match-card.expanded{border-color:var(--accent);background:rgba(59,130,246,0.04)}
.match-summary{display:grid;grid-template-columns:auto 1fr auto auto;align-items:center;gap:14px;padding:14px 18px}
.match-time{font-size:12px;color:var(--text-muted);text-align:center;min-width:50px;line-height:1.4}
.match-time .date{font-weight:500}
.match-teams{display:flex;flex-direction:column;gap:2px}
.match-teams .team{font-size:14px;font-weight:500}
.match-teams .team.home::before{content:'';display:inline-block;width:4px;height:4px;border-radius:50%;background:var(--home);margin-right:6px;vertical-align:middle}
.match-teams .team.away::before{content:'';display:inline-block;width:4px;height:4px;border-radius:50%;background:var(--away);margin-right:6px;vertical-align:middle}
.match-meta{display:flex;gap:6px;align-items:center}
.badge{font-size:10px;font-weight:600;padding:3px 8px;border-radius:var(--radius-xs);text-transform:uppercase;letter-spacing:0.3px}
.badge-nba{background:rgba(249,115,22,0.15);color:var(--nba)}
.badge-football{background:rgba(34,197,94,0.15);color:var(--football)}
.picks-count{font-size:12px;color:var(--text-muted);background:var(--surface);border:1px solid var(--border);padding:3px 10px;border-radius:var(--radius-xs);white-space:nowrap}

/* Expanded predictions */
.match-details{max-height:0;overflow:hidden;transition:max-height 0.3s ease}
.match-card.expanded .match-details{max-height:2000px}
.predictions-table{width:100%;border-collapse:collapse;font-size:13px}
.predictions-table th{text-align:left;padding:8px 14px;font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);background:rgba(0,0,0,0.2)}
.predictions-table td{padding:10px 14px;border-bottom:1px solid var(--border)}
.predictions-table tr:last-child td{border-bottom:none}

/* Side & confidence pills */
.side-pill{display:inline-block;font-size:11px;font-weight:600;padding:2px 8px;border-radius:var(--radius-xs);text-transform:uppercase}
.side-home{background:rgba(59,130,246,0.15);color:var(--home)}
.side-away{background:rgba(239,68,68,0.15);color:var(--away)}
.side-draw{background:rgba(168,85,247,0.15);color:var(--draw)}
.side-over{background:rgba(34,197,94,0.15);color:var(--over)}
.side-under{background:rgba(249,115,22,0.15);color:var(--under)}
.side-yes{background:rgba(16,185,129,0.15);color:var(--yes)}
.side-no{background:rgba(244,63,94,0.15);color:var(--no)}
.conf-pill{display:inline-block;font-size:10px;font-weight:600;padding:2px 7px;border-radius:var(--radius-xs)}
.conf-best_bet{background:rgba(234,179,8,0.15);color:var(--best-bet)}
.conf-high{background:rgba(34,197,94,0.15);color:var(--high)}
.conf-medium{background:rgba(59,130,246,0.15);color:var(--medium)}
.conf-low{background:rgba(100,116,139,0.2);color:var(--low)}
.pick-type{font-size:11px;color:var(--text-dim);font-weight:500}
.source-tag{font-size:11px;color:var(--text-muted)}
.value-text{font-weight:600;font-variant-numeric:tabular-nums}

/* Loading / empty */
.loading{text-align:center;padding:60px 20px;color:var(--text-muted)}
.loading .spinner{width:24px;height:24px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 12px}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:60px 20px;color:var(--text-muted);font-size:14px}

/* Responsive */
@media(max-width:640px){
  .match-summary{grid-template-columns:1fr;gap:8px}
  .match-meta{order:-1}
  .stats{grid-template-columns:repeat(2,1fr)}
  .filters{gap:8px}
}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="header-inner">
      <div class="logo">
        <h1>Bet Aggregator</h1>
        <span id="version">v1.0</span>
      </div>
      <div class="health" id="health">
        <div class="health-dot"></div>
        <span>Healthy</span>
        <span class="last-updated" id="last-updated"></span>
      </div>
    </div>
  </header>

  <div class="filters">
    <div class="filter-group" id="sport-filters">
      <button class="filter-btn active" data-sport="">All Sports</button>
      <button class="filter-btn sport-nba" data-sport="nba">NBA</button>
      <button class="filter-btn sport-football" data-sport="football">Football</button>
    </div>
    <div class="filter-group" id="source-filters"></div>
    <input type="date" id="date-filter" title="Filter by date">
  </div>

  <div class="stats" id="stats">
    <div class="stat-card"><div class="label">Predictions</div><div class="value" id="stat-preds">--</div><div class="sub" id="stat-preds-sub"></div></div>
    <div class="stat-card"><div class="label">Matches</div><div class="value" id="stat-matches">--</div><div class="sub" id="stat-matches-sub"></div></div>
    <div class="stat-card"><div class="label">Sources</div><div class="value" id="stat-sources">--</div><div class="sub" id="stat-sources-sub"></div></div>
    <div class="stat-card"><div class="label">Pick Types</div><div class="value" id="stat-types">--</div><div class="sub" id="stat-types-sub"></div></div>
  </div>

  <div class="matches-header">
    <h2>Matches</h2>
    <span class="count" id="matches-count"></span>
  </div>
  <div class="matches-grid" id="matches-grid">
    <div class="loading"><div class="spinner"></div>Loading matches...</div>
  </div>
</div>

<script>
const API = '';
const POLL_INTERVAL = 30000; // 30s
let currentSport = '';
let currentSource = '';
let currentDate = '';
let matchPredictions = {};
let lastStatsSig = '';
let lastMatchesSig = '';

// --- Fetch helpers ---
async function api(path) {
  const res = await fetch(API + path);
  return res.json();
}

// --- Stats ---
async function loadStats() {
  const s = await api('/predictions/stats');
  const sig = JSON.stringify(s);
  const changed = lastStatsSig && sig !== lastStatsSig;
  lastStatsSig = sig;

  document.getElementById('stat-preds').textContent = s.total_predictions?.toLocaleString() ?? '0';
  document.getElementById('stat-matches').textContent = s.total_matches?.toLocaleString() ?? '0';
  document.getElementById('stat-sources').textContent = s.active_sources ?? '0';
  document.getElementById('stat-types').textContent = s.pick_types ?? '0';

  if (s.bySport?.length) {
    document.getElementById('stat-preds-sub').textContent = s.bySport.map(x => `${x.sport}: ${x.count}`).join(' / ');
  }
  if (s.bySource?.length) {
    document.getElementById('stat-sources-sub').textContent = s.bySource.map(x => x.name).join(', ');
  }
  if (s.byPickType?.length) {
    document.getElementById('stat-types-sub').textContent = s.byPickType.map(x => `${x.pick_type}: ${x.count}`).join(' / ');
  }

  if (changed) flashStats();
  return changed;
}

function flashStats() {
  document.querySelectorAll('.stat-card').forEach(card => {
    card.classList.remove('updated');
    void card.offsetWidth; // force reflow
    card.classList.add('updated');
  });
}

// --- Sources (filter chips) ---
async function loadSources() {
  const res = await api('/sources');
  const container = document.getElementById('source-filters');
  container.innerHTML = '';
  const allBtn = document.createElement('button');
  allBtn.className = 'filter-btn active';
  allBtn.dataset.source = '';
  allBtn.textContent = 'All Sources';
  allBtn.onclick = () => selectSource('', allBtn);
  container.appendChild(allBtn);
  for (const src of res.data) {
    const btn = document.createElement('button');
    btn.className = 'filter-btn';
    btn.dataset.source = src.slug;
    btn.textContent = src.name;
    btn.onclick = () => selectSource(src.slug, btn);
    container.appendChild(btn);
  }
}

function selectSource(slug, btn) {
  currentSource = slug;
  document.querySelectorAll('#source-filters .filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  loadMatches();
}

// --- Sport filters ---
document.querySelectorAll('#sport-filters .filter-btn').forEach(btn => {
  btn.onclick = () => {
    currentSport = btn.dataset.sport;
    document.querySelectorAll('#sport-filters .filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    loadMatches();
  };
});

// --- Date filter ---
document.getElementById('date-filter').addEventListener('change', (e) => {
  currentDate = e.target.value;
  loadMatches();
});

// --- Matches ---
async function loadMatches(silent = false) {
  const grid = document.getElementById('matches-grid');
  if (!silent) {
    grid.innerHTML = '<div class="loading"><div class="spinner"></div>Loading matches...</div>';
  }

  const params = new URLSearchParams();
  if (currentSport) params.set('sport', currentSport);
  if (currentDate) params.set('date', currentDate);
  if (currentSource) params.set('source', currentSource);

  const res = await api('/predictions/matches?' + params.toString());
  const matches = res.data || [];
  const sig = JSON.stringify(matches.map(m => m.id + ':' + m.prediction_count));
  const changed = lastMatchesSig && sig !== lastMatchesSig;
  lastMatchesSig = sig;

  // On silent poll with no changes, skip DOM rebuild
  if (silent && !changed) return false;

  document.getElementById('matches-count').textContent = `${matches.length} matches`;

  if (!matches.length) {
    grid.innerHTML = '<div class="empty">No matches found for the selected filters.</div>';
    return changed;
  }

  // Remember which match was expanded
  const expandedId = document.querySelector('.match-card.expanded')?.dataset.matchId;

  grid.innerHTML = '';
  let lastDate = '';
  for (const m of matches) {
    const dateStr = formatDate(toDateStr(m.game_date));
    if (dateStr !== lastDate) {
      lastDate = dateStr;
      const divider = document.createElement('div');
      divider.style.cssText = 'font-size:12px;color:var(--text-muted);padding:12px 0 4px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;border-top:1px solid var(--border);margin-top:8px';
      divider.textContent = dateStr;
      grid.appendChild(divider);
    }
    grid.appendChild(createMatchCard(m));
  }

  // Re-expand the previously expanded match
  if (expandedId) {
    const card = document.querySelector(`.match-card[data-match-id="${expandedId}"]`);
    if (card) toggleMatch(card, expandedId);
  }

  return changed;
}

function createMatchCard(m) {
  const card = document.createElement('div');
  card.className = 'match-card';
  card.dataset.matchId = m.id;

  const sportClass = m.sport === 'nba' ? 'nba' : 'football';
  const time = m.game_time || '';

  card.innerHTML = `
    <div class="match-summary">
      <div class="match-time">
        <div class="date">${formatShortDate(m.game_date)}</div>
        <div>${time}</div>
      </div>
      <div class="match-teams">
        <div class="team home">${esc(m.home_team)}</div>
        <div class="team away">${esc(m.away_team)}</div>
      </div>
      <div class="match-meta">
        <span class="badge badge-${sportClass}">${m.sport}</span>
      </div>
      <div class="picks-count">${m.prediction_count} picks</div>
    </div>
    <div class="match-details" id="details-${m.id}"></div>
  `;

  card.querySelector('.match-summary').onclick = () => toggleMatch(card, m.id);
  return card;
}

async function toggleMatch(card, matchId) {
  const wasExpanded = card.classList.contains('expanded');
  // Collapse all
  document.querySelectorAll('.match-card.expanded').forEach(c => {
    c.classList.remove('expanded');
  });
  if (wasExpanded) return;

  card.classList.add('expanded');
  const container = document.getElementById('details-' + matchId);

  if (matchPredictions[matchId]) {
    renderPredictions(container, matchPredictions[matchId]);
    return;
  }

  container.innerHTML = '<div class="loading" style="padding:20px"><div class="spinner"></div></div>';
  const res = await api('/predictions/' + matchId);
  matchPredictions[matchId] = res.data || [];
  renderPredictions(container, matchPredictions[matchId]);
}

function renderPredictions(container, preds) {
  if (!preds.length) {
    container.innerHTML = '<div class="empty" style="padding:16px">No predictions</div>';
    return;
  }
  let rows = '';
  for (const p of preds) {
    const conf = p.confidence ? `<span class="conf-pill conf-${p.confidence}">${p.confidence.replace('_',' ')}</span>` : '';
    const val = p.value != null ? p.value : '--';
    const reasoning = p.reasoning ? `<div style="font-size:11px;color:var(--text-muted);margin-top:2px">${esc(p.reasoning)}</div>` : '';
    // For over/under, show line with the side (e.g. "Over 2.5")
    const isOU = p.side === 'over' || p.side === 'under';
    const sideLabel = isOU && val !== '--' ? `${p.side} ${val}` : p.side;
    const valDisplay = isOU && val !== '--' ? '' : val;
    rows += `<tr>
      <td><span class="source-tag">${esc(p.source_name)}</span></td>
      <td><span class="pick-type">${p.pick_type.replace('_',' ')}</span></td>
      <td><span class="side-pill side-${p.side}">${sideLabel}</span></td>
      <td class="value-text">${valDisplay}</td>
      <td>${conf}</td>
      <td>${esc(p.picker_name)}${reasoning}</td>
    </tr>`;
  }
  container.innerHTML = `<table class="predictions-table">
    <thead><tr><th>Source</th><th>Type</th><th>Side</th><th>Value</th><th>Conf</th><th>Picker</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

// --- Health ---
async function checkHealth() {
  try {
    const h = await api('/health');
    const el = document.getElementById('health');
    const dot = el.querySelector('.health-dot');
    const txt = el.querySelector('span');
    if (h.status === 'healthy') {
      dot.style.background = '#22c55e';
      dot.style.boxShadow = '0 0 8px rgba(34,197,94,0.5)';
      txt.textContent = 'Healthy';
    } else {
      dot.style.background = '#eab308';
      dot.style.boxShadow = '0 0 8px rgba(234,179,8,0.5)';
      txt.textContent = 'Degraded';
    }
  } catch {
    const el = document.getElementById('health');
    el.querySelector('.health-dot').style.background = '#ef4444';
    el.querySelector('span').textContent = 'Offline';
  }
}

// --- Helpers ---
function toDateStr(d) {
  if (!d) return '';
  return d.includes('T') ? d.split('T')[0] : d;
}
function formatDate(d) {
  if (!d) return '';
  const date = new Date(toDateStr(d) + 'T12:00:00');
  return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
}
function formatShortDate(d) {
  if (!d) return '';
  const date = new Date(toDateStr(d) + 'T12:00:00');
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}
function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function updateTimestamp() {
  const el = document.getElementById('last-updated');
  el.textContent = 'Updated ' + new Date().toLocaleTimeString();
}

// --- Auto-poll ---
async function poll() {
  try {
    const [statsChanged, matchesChanged] = await Promise.all([
      loadStats(),
      loadMatches(true),
    ]);
    // If data changed, clear cached predictions so expanded cards get fresh data
    if (statsChanged || matchesChanged) {
      matchPredictions = {};
    }
    updateTimestamp();
  } catch (e) {
    // Silently ignore poll errors â€” health check handles offline state
  }
}

// --- Init ---
(async () => {
  await Promise.all([loadStats(), loadSources(), loadMatches(), checkHealth()]);
  updateTimestamp();
  setInterval(checkHealth, POLL_INTERVAL);
  setInterval(poll, POLL_INTERVAL);
})();
</script>
</body>
</html>
