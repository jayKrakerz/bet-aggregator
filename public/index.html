<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bet Aggregator</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07070d;--bg2:#0d0d16;--surface:rgba(255,255,255,0.035);--surface-hover:rgba(255,255,255,0.06);
  --glass:rgba(15,15,25,0.6);
  --border:rgba(255,255,255,0.07);--border-hover:rgba(255,255,255,0.14);
  --text:#e8ecf4;--text-dim:#94a3b8;--text-muted:#5a6578;
  --accent:#6366f1;--accent2:#818cf8;--accent-glow:rgba(99,102,241,0.12);--accent-glow2:rgba(99,102,241,0.25);
  --nba:#fb923c;--nba-bg:rgba(251,146,60,0.1);
  --football:#34d399;--football-bg:rgba(52,211,153,0.1);
  --home:#60a5fa;--away:#f87171;--draw:#c084fc;
  --over:#34d399;--under:#fb923c;--yes:#34d399;--no:#fb7185;
  --gold:#fbbf24;--gold-bg:rgba(251,191,36,0.1);--gold-border:rgba(251,191,36,0.25);
  --high:#34d399;--medium:#60a5fa;--low:#5a6578;
  --radius:14px;--radius-sm:10px;--radius-xs:6px;
}
html{font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);font-size:14px;-webkit-font-smoothing:antialiased}
body{min-height:100vh;background:
  radial-gradient(ellipse 80% 50% at 50% -10%,rgba(99,102,241,0.1) 0%,transparent 60%),
  radial-gradient(circle at 80% 80%,rgba(52,211,153,0.04) 0%,transparent 40%);
  overflow-x:hidden}

::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:10px}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.14)}

/* Layout */
.container{max-width:1100px;margin:0 auto;padding:0 24px 60px}

/* Header */
header{padding:24px 0 20px;margin-bottom:4px}
.header-inner{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
.logo{display:flex;align-items:baseline;gap:10px}
.logo h1{font-size:18px;font-weight:700;letter-spacing:-0.3px;background:linear-gradient(135deg,var(--accent2),var(--text));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo .ver{font-size:10px;color:var(--text-muted);font-weight:500;background:var(--surface);padding:2px 7px;border-radius:4px;border:1px solid var(--border);letter-spacing:0.3px}
.header-right{display:flex;align-items:center;gap:14px}
.health{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-dim);background:var(--surface);padding:5px 12px;border-radius:20px;border:1px solid var(--border)}
.health-dot{width:6px;height:6px;border-radius:50%;background:#34d399;box-shadow:0 0 6px rgba(52,211,153,0.6);flex-shrink:0}
.last-updated{font-size:11px;color:var(--text-muted)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.health-dot{animation:pulse 2.5s ease-in-out infinite}

/* Filters */
.filters{padding:8px 0 6px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.filter-group{display:flex;gap:3px}
.filter-btn{padding:6px 14px;font-size:12px;font-weight:500;border:1px solid var(--border);border-radius:20px;background:transparent;color:var(--text-muted);cursor:pointer;transition:all 0.2s;font-family:inherit;letter-spacing:0.1px}
.filter-btn:hover{border-color:var(--border-hover);color:var(--text-dim);background:var(--surface)}
.filter-btn.active{background:var(--accent-glow);border-color:rgba(99,102,241,0.3);color:var(--accent2)}
.filter-btn.sport-nba.active{background:var(--nba-bg);border-color:rgba(251,146,60,0.3);color:var(--nba)}
.filter-btn.sport-football.active{background:var(--football-bg);border-color:rgba(52,211,153,0.3);color:var(--football)}
input[type=date]{padding:6px 12px;font-size:12px;border:1px solid var(--border);border-radius:20px;background:transparent;color:var(--text);font-family:inherit;cursor:pointer}
input[type=date]::-webkit-calendar-picker-indicator{filter:invert(0.6)}
input[type=date]:hover{border-color:var(--border-hover);background:var(--surface)}

/* Stats */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;padding:16px 0 20px}
.stat-card{background:var(--glass);border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px;backdrop-filter:blur(16px);position:relative;overflow:hidden;transition:border-color 0.3s,transform 0.2s}
.stat-card:hover{border-color:var(--border-hover);transform:translateY(-1px)}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.06),transparent)}
.stat-card .label{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.8px;font-weight:500;margin-bottom:6px}
.stat-card .value{font-size:26px;font-weight:700;letter-spacing:-0.5px;line-height:1}
.stat-card .sub{font-size:11px;color:var(--text-muted);margin-top:6px;line-height:1.3}
@keyframes flash-update{0%{border-color:var(--accent)}100%{border-color:var(--border)}}
.stat-card.updated{animation:flash-update 1.5s ease-out}

/* Tabs */
.tabs{display:flex;gap:2px;padding:2px;background:var(--surface);border-radius:var(--radius-sm);width:fit-content;margin-bottom:16px}
.tab-btn{padding:8px 20px;font-size:13px;font-weight:600;border:none;background:transparent;color:var(--text-muted);cursor:pointer;border-radius:var(--radius-xs);transition:all 0.2s;font-family:inherit;letter-spacing:-0.1px}
.tab-btn:hover{color:var(--text-dim)}
.tab-btn.active{background:var(--accent-glow);color:var(--accent2);box-shadow:0 1px 4px rgba(0,0,0,0.2)}
.tab-content{display:none}
.tab-content.active{display:block}

/* Section headers */
.section-header{display:flex;align-items:center;justify-content:space-between;padding:4px 0 14px}
.section-header h2{font-size:14px;font-weight:600;color:var(--text-dim);letter-spacing:-0.2px}
.section-header .count{font-size:12px;color:var(--text-muted);background:var(--surface);padding:3px 10px;border-radius:20px;border:1px solid var(--border)}

/* Date divider */
.date-divider{font-size:11px;color:var(--text-muted);padding:16px 0 8px;font-weight:600;text-transform:uppercase;letter-spacing:0.6px;display:flex;align-items:center;gap:12px}
.date-divider::after{content:'';flex:1;height:1px;background:var(--border)}

/* Match Cards */
.matches-grid{display:grid;gap:6px;padding-bottom:20px}
.match-card{background:var(--glass);border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;transition:all 0.25s;cursor:pointer;backdrop-filter:blur(12px)}
.match-card:hover{border-color:var(--border-hover);background:var(--surface-hover)}
.match-card.expanded{border-color:rgba(99,102,241,0.25);box-shadow:0 4px 24px rgba(99,102,241,0.08)}
.match-summary{display:grid;grid-template-columns:48px 1fr auto auto;align-items:center;gap:14px;padding:12px 16px}
.match-time{font-size:11px;color:var(--text-muted);text-align:center;line-height:1.5}
.match-time .date{font-weight:600;color:var(--text-dim);font-size:12px}
.match-teams{display:flex;flex-direction:column;gap:3px}
.match-teams .team{font-size:13px;font-weight:500;display:flex;align-items:center;gap:6px}
.match-teams .team::before{content:'';width:3px;height:3px;border-radius:50%;flex-shrink:0}
.match-teams .team.home::before{background:var(--home)}
.match-teams .team.away::before{background:var(--away)}
.match-meta{display:flex;gap:6px;align-items:center}
.badge{font-size:9px;font-weight:700;padding:3px 8px;border-radius:4px;text-transform:uppercase;letter-spacing:0.5px}
.badge-nba{background:var(--nba-bg);color:var(--nba)}
.badge-football{background:var(--football-bg);color:var(--football)}
.picks-count{font-size:11px;color:var(--text-muted);background:var(--surface);padding:4px 10px;border-radius:20px;white-space:nowrap;font-weight:500;font-variant-numeric:tabular-nums}

/* Expanded predictions */
.match-details{max-height:0;overflow:hidden;transition:max-height 0.35s cubic-bezier(0.4,0,0.2,1)}
.match-card.expanded .match-details{max-height:2000px}
.predictions-table{width:100%;border-collapse:collapse;font-size:12px}
.predictions-table th{text-align:left;padding:8px 14px;font-size:10px;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.6px;font-weight:600;border-top:1px solid var(--border);background:rgba(0,0,0,0.15)}
.predictions-table td{padding:10px 14px;border-top:1px solid rgba(255,255,255,0.03)}
.predictions-table tbody tr{transition:background 0.15s}
.predictions-table tbody tr:hover{background:rgba(255,255,255,0.02)}

/* Side & confidence pills */
.side-pill{display:inline-flex;align-items:center;font-size:10px;font-weight:700;padding:3px 9px;border-radius:4px;text-transform:uppercase;letter-spacing:0.3px}
.side-home{background:rgba(96,165,250,0.12);color:var(--home)}
.side-away{background:rgba(248,113,113,0.12);color:var(--away)}
.side-draw{background:rgba(192,132,252,0.12);color:var(--draw)}
.side-over{background:rgba(52,211,153,0.12);color:var(--over)}
.side-under{background:rgba(251,146,60,0.12);color:var(--under)}
.side-yes{background:rgba(52,211,153,0.12);color:var(--yes)}
.side-no{background:rgba(251,113,133,0.12);color:var(--no)}
.conf-pill{display:inline-flex;align-items:center;font-size:10px;font-weight:600;padding:2px 8px;border-radius:4px}
.conf-best_bet{background:var(--gold-bg);color:var(--gold)}
.conf-high{background:rgba(52,211,153,0.12);color:var(--high)}
.conf-medium{background:rgba(96,165,250,0.12);color:var(--medium)}
.conf-low{background:rgba(90,101,120,0.15);color:var(--low)}
.pick-type{font-size:11px;color:var(--text-muted);font-weight:500}
.source-tag{font-size:11px;color:var(--text-muted)}
.value-text{font-weight:600;font-variant-numeric:tabular-nums;color:var(--text-dim)}

/* Multi cards */
.multis-grid{display:grid;gap:14px;padding-bottom:20px}
.multi-card{background:var(--glass);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;backdrop-filter:blur(16px);position:relative}
.multi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent),var(--gold),var(--accent))}
.multi-card-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border)}
.multi-date{font-size:13px;font-weight:600;color:var(--text)}
.multi-odds{display:flex;align-items:center;gap:10px}
.multi-odds .combined{font-size:22px;font-weight:800;color:var(--gold);letter-spacing:-0.5px}
.multi-odds .prob{font-size:11px;color:var(--gold);background:var(--gold-bg);padding:3px 10px;border-radius:20px;font-weight:600;border:1px solid var(--gold-border)}
.multi-legs{display:grid;gap:0}
.multi-leg{display:grid;grid-template-columns:32px 1fr auto;align-items:center;gap:16px;padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.04);transition:background 0.15s}
.multi-leg:last-child{border-bottom:none}
.multi-leg:hover{background:rgba(255,255,255,0.015)}
.multi-leg-num{width:28px;height:28px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:var(--accent-glow);color:var(--accent2);font-size:12px;font-weight:800}
.multi-leg-match{display:flex;flex-direction:column;gap:4px}
.multi-leg-match .teams{font-size:13px;font-weight:500;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.multi-leg-match .teams .vs{color:var(--text-muted);font-size:12px;font-weight:400}
.multi-leg-match .meta-row{display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text-muted)}
.multi-leg-pick{display:flex;flex-direction:column;align-items:flex-end;gap:2px;min-width:70px}
.multi-leg-pick .odds{font-size:18px;font-weight:800;font-variant-numeric:tabular-nums;letter-spacing:-0.3px}
.multi-leg-pick .prob-sm{font-size:10px;color:var(--text-muted);font-weight:500}

/* Loading / empty */
.loading{text-align:center;padding:60px 20px;color:var(--text-muted)}
.loading .spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.7s linear infinite;margin:0 auto 10px}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:60px 20px;color:var(--text-muted);font-size:13px}

/* Responsive */
@media(max-width:768px){
  .stats{grid-template-columns:repeat(2,1fr)}
}
@media(max-width:640px){
  .container{padding:0 16px 40px}
  .match-summary{grid-template-columns:1fr;gap:8px}
  .match-time{text-align:left;display:flex;gap:8px}
  .match-meta{order:-1}
  .stats{grid-template-columns:repeat(2,1fr);gap:8px}
  .stat-card{padding:12px 14px}
  .stat-card .value{font-size:22px}
  .filters{gap:6px}
  .multi-leg{grid-template-columns:28px 1fr auto;gap:10px;padding:12px 14px}
  .multi-card-header{padding:12px 14px}
  .header-inner{gap:10px}
  .tabs{width:100%}
  .tab-btn{flex:1;text-align:center}
}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="header-inner">
      <div class="logo">
        <h1>Bet Aggregator</h1>
        <span class="ver">BETA</span>
      </div>
      <div class="header-right">
        <span class="last-updated" id="last-updated"></span>
        <div class="health" id="health">
          <div class="health-dot"></div>
          <span>Live</span>
        </div>
      </div>
    </div>
  </header>

  <div class="filters">
    <div class="filter-group" id="sport-filters">
      <button class="filter-btn active" data-sport="">All</button>
      <button class="filter-btn sport-nba" data-sport="nba">NBA</button>
      <button class="filter-btn sport-football" data-sport="football">Football</button>
    </div>
    <div class="filter-group" id="source-filters"></div>
    <input type="date" id="date-filter" title="Filter by date">
  </div>

  <div class="stats" id="stats">
    <div class="stat-card"><div class="label">Predictions</div><div class="value" id="stat-preds">--</div><div class="sub" id="stat-preds-sub"></div></div>
    <div class="stat-card"><div class="label">Matches</div><div class="value" id="stat-matches">--</div><div class="sub" id="stat-matches-sub"></div></div>
    <div class="stat-card"><div class="label">Sources</div><div class="value" id="stat-sources">--</div><div class="sub" id="stat-sources-sub"></div></div>
    <div class="stat-card"><div class="label">Pick Types</div><div class="value" id="stat-types">--</div><div class="sub" id="stat-types-sub"></div></div>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="matches">Matches</button>
    <button class="tab-btn" data-tab="multis">Best Multis</button>
  </div>

  <div class="tab-content active" id="tab-matches">
    <div class="section-header">
      <h2>All Matches</h2>
      <span class="count" id="matches-count"></span>
    </div>
    <div class="matches-grid" id="matches-grid">
      <div class="loading"><div class="spinner"></div>Loading...</div>
    </div>
  </div>

  <div class="tab-content" id="tab-multis">
    <div class="section-header">
      <h2>Best 2-Leg Multi Per Day</h2>
      <span class="count" id="multis-count"></span>
    </div>
    <div class="multis-grid" id="multis-grid">
      <div class="loading"><div class="spinner"></div>Loading...</div>
    </div>
  </div>
</div>

<script>
const API = '';
const POLL_INTERVAL = 30000;
let currentSport = '';
let currentSource = '';
let currentDate = '';
let matchPredictions = {};
let lastStatsSig = '';
let lastMatchesSig = '';

async function api(path) {
  const res = await fetch(API + path);
  return res.json();
}

// --- Stats ---
async function loadStats() {
  const s = await api('/predictions/stats');
  const sig = JSON.stringify(s);
  const changed = lastStatsSig && sig !== lastStatsSig;
  lastStatsSig = sig;

  document.getElementById('stat-preds').textContent = s.total_predictions?.toLocaleString() ?? '0';
  document.getElementById('stat-matches').textContent = s.total_matches?.toLocaleString() ?? '0';
  document.getElementById('stat-sources').textContent = s.active_sources ?? '0';
  document.getElementById('stat-types').textContent = s.pick_types ?? '0';

  if (s.bySport?.length)
    document.getElementById('stat-preds-sub').textContent = s.bySport.map(x => `${x.sport}: ${x.count}`).join(' / ');
  if (s.bySource?.length)
    document.getElementById('stat-sources-sub').textContent = s.bySource.map(x => x.name).join(', ');
  if (s.byPickType?.length)
    document.getElementById('stat-types-sub').textContent = s.byPickType.map(x => `${x.pick_type}: ${x.count}`).join(' / ');

  if (changed) flashStats();
  return changed;
}

function flashStats() {
  document.querySelectorAll('.stat-card').forEach(card => {
    card.classList.remove('updated');
    void card.offsetWidth;
    card.classList.add('updated');
  });
}

// --- Sources ---
async function loadSources() {
  const res = await api('/sources');
  const container = document.getElementById('source-filters');
  container.innerHTML = '';
  const allBtn = document.createElement('button');
  allBtn.className = 'filter-btn active';
  allBtn.dataset.source = '';
  allBtn.textContent = 'All Sources';
  allBtn.onclick = () => selectSource('', allBtn);
  container.appendChild(allBtn);
  for (const src of res.data) {
    const btn = document.createElement('button');
    btn.className = 'filter-btn';
    btn.dataset.source = src.slug;
    btn.textContent = src.name;
    btn.onclick = () => selectSource(src.slug, btn);
    container.appendChild(btn);
  }
}

function selectSource(slug, btn) {
  currentSource = slug;
  document.querySelectorAll('#source-filters .filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  loadMatches();
}

// --- Tabs ---
let currentTab = 'matches';
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.onclick = () => {
    currentTab = btn.dataset.tab;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById('tab-' + currentTab).classList.add('active');
    if (currentTab === 'multis') loadMultis();
  };
});

// --- Sport filters ---
document.querySelectorAll('#sport-filters .filter-btn').forEach(btn => {
  btn.onclick = () => {
    currentSport = btn.dataset.sport;
    document.querySelectorAll('#sport-filters .filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    loadMatches();
  };
});

// --- Date filter ---
document.getElementById('date-filter').addEventListener('change', (e) => {
  currentDate = e.target.value;
  loadMatches();
});

// --- Matches ---
async function loadMatches(silent = false) {
  const grid = document.getElementById('matches-grid');
  if (!silent) grid.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

  const params = new URLSearchParams();
  if (currentSport) params.set('sport', currentSport);
  if (currentDate) params.set('date', currentDate);
  if (currentSource) params.set('source', currentSource);

  const res = await api('/predictions/matches?' + params.toString());
  const matches = res.data || [];
  const sig = JSON.stringify(matches.map(m => m.id + ':' + m.prediction_count));
  const changed = lastMatchesSig && sig !== lastMatchesSig;
  lastMatchesSig = sig;

  if (silent && !changed) return false;

  document.getElementById('matches-count').textContent = `${matches.length} matches`;

  if (!matches.length) {
    grid.innerHTML = '<div class="empty">No matches found for the selected filters.</div>';
    return changed;
  }

  const expandedId = document.querySelector('.match-card.expanded')?.dataset.matchId;

  grid.innerHTML = '';
  let lastDate = '';
  for (const m of matches) {
    const dateStr = formatDate(toDateStr(m.game_date));
    if (dateStr !== lastDate) {
      lastDate = dateStr;
      const divider = document.createElement('div');
      divider.className = 'date-divider';
      divider.textContent = dateStr;
      grid.appendChild(divider);
    }
    grid.appendChild(createMatchCard(m));
  }

  if (expandedId) {
    const card = document.querySelector(`.match-card[data-match-id="${expandedId}"]`);
    if (card) toggleMatch(card, expandedId);
  }

  return changed;
}

function createMatchCard(m) {
  const card = document.createElement('div');
  card.className = 'match-card';
  card.dataset.matchId = m.id;

  const sportClass = m.sport === 'nba' ? 'nba' : 'football';
  const time = m.game_time || '';

  card.innerHTML = `
    <div class="match-summary">
      <div class="match-time">
        <div class="date">${formatShortDate(m.game_date)}</div>
        <div>${time}</div>
      </div>
      <div class="match-teams">
        <div class="team home">${esc(m.home_team)}</div>
        <div class="team away">${esc(m.away_team)}</div>
      </div>
      <div class="match-meta">
        <span class="badge badge-${sportClass}">${m.sport}</span>
      </div>
      <div class="picks-count">${m.prediction_count} picks</div>
    </div>
    <div class="match-details" id="details-${m.id}"></div>
  `;

  card.querySelector('.match-summary').onclick = () => toggleMatch(card, m.id);
  return card;
}

async function toggleMatch(card, matchId) {
  const wasExpanded = card.classList.contains('expanded');
  document.querySelectorAll('.match-card.expanded').forEach(c => c.classList.remove('expanded'));
  if (wasExpanded) return;

  card.classList.add('expanded');
  const container = document.getElementById('details-' + matchId);

  if (matchPredictions[matchId]) {
    renderPredictions(container, matchPredictions[matchId]);
    return;
  }

  container.innerHTML = '<div class="loading" style="padding:20px"><div class="spinner"></div></div>';
  const res = await api('/predictions/' + matchId);
  matchPredictions[matchId] = res.data || [];
  renderPredictions(container, matchPredictions[matchId]);
}

function renderPredictions(container, preds) {
  if (!preds.length) {
    container.innerHTML = '<div class="empty" style="padding:16px">No predictions</div>';
    return;
  }
  let rows = '';
  for (const p of preds) {
    const conf = p.confidence ? `<span class="conf-pill conf-${p.confidence}">${p.confidence.replace('_',' ')}</span>` : '';
    const val = p.value != null ? p.value : '--';
    const reasoning = p.reasoning ? `<div style="font-size:10px;color:var(--text-muted);margin-top:3px">${esc(p.reasoning)}</div>` : '';
    const isOU = p.side === 'over' || p.side === 'under';
    const sideLabel = isOU && val !== '--' ? `${p.side} ${val}` : p.side;
    const valDisplay = isOU && val !== '--' ? '' : val;
    rows += `<tr>
      <td><span class="source-tag">${esc(p.source_name)}</span></td>
      <td><span class="pick-type">${p.pick_type.replace('_',' ')}</span></td>
      <td><span class="side-pill side-${p.side}">${sideLabel}</span></td>
      <td class="value-text">${valDisplay}</td>
      <td>${conf}</td>
      <td>${esc(p.picker_name)}${reasoning}</td>
    </tr>`;
  }
  container.innerHTML = `<table class="predictions-table">
    <thead><tr><th>Source</th><th>Type</th><th>Side</th><th>Value</th><th>Conf</th><th>Picker</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

// --- Best Multis ---
async function loadMultis() {
  const grid = document.getElementById('multis-grid');
  grid.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

  const res = await api('/predictions/best-multis');
  const multis = res.data || [];

  document.getElementById('multis-count').textContent = `${multis.length} days`;

  if (!multis.length) {
    grid.innerHTML = '<div class="empty">No multi picks available yet.</div>';
    return;
  }

  grid.innerHTML = '';
  for (const m of multis) {
    const card = document.createElement('div');
    card.className = 'multi-card';

    let legsHtml = '';
    for (let i = 0; i < m.legs.length; i++) {
      const l = m.legs[i];
      const sideClass = l.side === 'home' ? 'home' : l.side === 'away' ? 'away' : 'draw';
      const pick = l.side === 'home' ? l.homeTeam : l.side === 'away' ? l.awayTeam : 'Draw';
      const opponent = l.side === 'home' ? 'vs ' + l.awayTeam : l.side === 'away' ? '@ ' + l.homeTeam : l.homeTeam + ' vs ' + l.awayTeam;
      const sportClass = l.sport === 'nba' ? 'nba' : 'football';
      const league = l.league || l.sport.toUpperCase();
      const time = l.gameTime || '';

      legsHtml += `
        <div class="multi-leg">
          <div class="multi-leg-num">${i + 1}</div>
          <div class="multi-leg-match">
            <div class="teams">
              <span class="side-pill side-${sideClass}">${esc(pick)}</span>
              <span class="vs">${esc(opponent)}</span>
            </div>
            <div class="meta-row">
              <span class="badge badge-${sportClass}">${l.sport}</span>
              <span>${esc(league)}</span>
              ${time ? '<span>' + time + '</span>' : ''}
              <span>${esc(l.picker)}</span>
            </div>
          </div>
          <div class="multi-leg-pick">
            <div class="odds">${l.decOdds.toFixed(2)}</div>
            <div class="prob-sm">${l.impliedProb}%</div>
          </div>
        </div>`;
    }

    card.innerHTML = `
      <div class="multi-card-header">
        <div class="multi-date">${formatDate(m.date)}</div>
        <div class="multi-odds">
          <span class="prob">${m.combinedProb}% implied</span>
          <span class="combined">${m.combinedOdds.toFixed(2)}x</span>
        </div>
      </div>
      <div class="multi-legs">${legsHtml}</div>
    `;
    grid.appendChild(card);
  }
}

// --- Health ---
async function checkHealth() {
  try {
    const h = await api('/health');
    const el = document.getElementById('health');
    const dot = el.querySelector('.health-dot');
    const txt = el.querySelector('span');
    if (h.status === 'healthy') {
      dot.style.background = '#34d399';
      dot.style.boxShadow = '0 0 6px rgba(52,211,153,0.6)';
      txt.textContent = 'Live';
    } else {
      dot.style.background = '#fbbf24';
      dot.style.boxShadow = '0 0 6px rgba(251,191,36,0.6)';
      txt.textContent = 'Degraded';
    }
  } catch {
    const el = document.getElementById('health');
    el.querySelector('.health-dot').style.background = '#f87171';
    el.querySelector('span').textContent = 'Offline';
  }
}

// --- Helpers ---
function toDateStr(d) {
  if (!d) return '';
  return String(d).includes('T') ? String(d).split('T')[0] : String(d);
}
function formatDate(d) {
  if (!d) return '';
  const date = new Date(toDateStr(d) + 'T12:00:00');
  return date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
}
function formatShortDate(d) {
  if (!d) return '';
  const date = new Date(toDateStr(d) + 'T12:00:00');
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}
function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function updateTimestamp() {
  const el = document.getElementById('last-updated');
  el.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// --- Auto-poll ---
async function poll() {
  try {
    const [statsChanged, matchesChanged] = await Promise.all([
      loadStats(),
      loadMatches(true),
    ]);
    if (statsChanged || matchesChanged) matchPredictions = {};
    updateTimestamp();
  } catch (e) {}
}

// --- Init ---
(async () => {
  await Promise.all([loadStats(), loadSources(), loadMatches(), checkHealth()]);
  updateTimestamp();
  setInterval(checkHealth, POLL_INTERVAL);
  setInterval(poll, POLL_INTERVAL);
})();
</script>
</body>
</html>
